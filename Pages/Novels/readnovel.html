<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>READ NOVELS - Kho Truyện</title>
        <meta name="description" content="Learn about NMT, the author of LEGNAXE, their writing philosophy, and the two-part structure of the epic saga.">
        <meta property="og:title" content="READ NOVELS - Kho Truyện">
        <meta property="og:description" content="Discover the creative mind behind LEGNAXE, NMT, and their passion for storytelling, blending ancient texts with original ideas.">
        <meta property="og:image" content="images\pages\novels\logo-legnaxe.png">     <meta property="og:url" content="https://ivs.id.vn/author-about.html">     <meta property="og:type" content="article">
        <meta property="article:section" content="Author Information">
        <meta property="article:author" content="NMT">

        <link rel="icon" href="images\pages\novels\logo-legnaxe.png" type="image/x-icon">     <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'sans-serif'],
                            serif: ['Merriweather', 'serif'],
                        },
                        colors: {
                            primary: '#3b82f6',
                            'primary-dark': '#2563eb',
                            'purple-accent': '#8b5cf6',
                            'gray-50': '#f9fafb',
                            'gray-100': '#f3f4f6',
                            'gray-200': '#e5e7eb',
                            'gray-300': '#d1d5db',
                            'gray-400': '#9ca3af',
                            'gray-500': '#6b7280',
                            'gray-600': '#4b5563',
                            'gray-700': '#374151',
                            'gray-800': '#1f2937',
                            'gray-900': '#111827',
                            'blue-200': '#bfdbfe',
                            'blue-400': '#60a5fa',
                            'blue-600': '#2563eb',
                            'blue-700': '#1d4ed8',
                            'red-400': '#f87171',
                            'red-600': '#dc2626',
                        },
                        animation: {
                            'slide-up': 'slideUp 0.5s ease-out',
                        },
                        keyframes: {
                            slideUp: {
                                '0%': { transform: 'translateY(20px)', opacity: '0' },
                                '100%': { transform: 'translateY(0)', opacity: '1' },
                            },
                        },
                    },
                },
                darkMode: 'class',
            }
        </script>

    <style>
        html {
            scroll-behavior: smooth;
        }

            .section {
            padding: 2rem 1rem;
            margin-bottom: 2rem; /* Increased margin-bottom for clearer separation */
            border-radius: 8px;
            }

            .section-light {
            background-color: #ffffff; /* Màu nền sáng hơn */
            color: #1f2937; /* Màu chữ tối hơn */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); /* Added subtle shadow */
            }

            .section-dark {
                background-color: #2d3748; /* Màu nền tối hơn nhưng không quá đậm */
                color: #f7fafc; /* Màu chữ sáng hơn */
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Added subtle shadow */
            }

            .section h2, .section h3 {
                color: #3b82f6; /* Màu tiêu đề nổi bật */
            }

            .section p, .section ul {
                line-height: 1.8;
            }

            .section ul {
                list-style: disc;
                margin-left: 1.5rem;
            }

            .section img {
                max-width: 100%;
                border-radius: 8px;
                margin-bottom: 1.5rem;
            }

            .image-container {
                margin-bottom: 1.5rem;
                text-align: center; /* Center images if they are smaller than the container */
            }

            .image-container img {
            display: inline-block; /* Allows centering */
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Optional shadow */
            }

            /* Styles for the horizontal scrolling gallery */
            .gallery-scroll-box {
                display: flex; /* Arrange items in a row */
                overflow-x: auto; /* Enable horizontal scrolling */
                gap: 1rem; /* Space between images */
                padding: 1rem; /* Padding inside the box */
                background-color: #e5e7eb; /* Light gray background */
                border-radius: 8px;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06); /* Inner shadow */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                scrollbar-width: thin; /* Firefox scrollbar */
                scrollbar-color: #3b82f6 #e5e7eb; /* Firefox scrollbar colors */
            }

            /* Style the scrollbar track */
            .gallery-scroll-box::-webkit-scrollbar-track {
                background: #e5e7eb;
                border-radius: 10px;
            }

            /* Style the scrollbar thumb */
            .gallery-scroll-box::-webkit-scrollbar-thumb {
                background: #3b82f6;
                border-radius: 10px;
            }

            .gallery-item {
                flex-shrink: 0; /* Prevent items from shrinking */
                width: 150px; /* Fixed width for gallery items */
                height: 150px; /* Fixed height for gallery items */
                position: relative;
                overflow: hidden;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .gallery-item img {
                width: 100%;
                height: 100%;
                object-fit: cover; /* Crop image to fit the container */
                transition: transform 0.3s ease-in-out;
            }

            .gallery-item img:hover {
                transform: scale(1.05); /* Zoom effect on hover */
            }

            /* Responsive adjustments for gallery item size */
            @media (min-width: 640px) { /* sm breakpoint */
                .gallery-item {
                    width: 180px;
                    height: 180px;
                }
            }
            @media (min-width: 768px) { /* md breakpoint */
                    .gallery-item {
                    width: 200px;
                    height: 200px;
                }
            }

            .excerpt {
                font-style: italic;
                padding-left: 1rem;
                border-left: 3px solid #3b82f6;
                margin-top: 1rem;
                margin-bottom: 1rem;
            }
        </style>
    </head>
    <body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300 ease-in-out font-sans antialiased">
        <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-0 focus:left-0 bg-blue-600 text-white px-4 py-2">Skip to content</a>
        <header id="navbar" class="bg-gray-50 dark:bg-gray-800 shadow-lg sticky top-0 z-50 transition-colors duration-300 ease-in-out">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-20">
                <div class="logo">
                    <a href="readnovel.html" aria-label="LEGNAXE Homepage">
                        <img src="images\pages\novels\logo-legnaxe.png" alt="LEGNAXE Logo" class="h-10 sm:h-12 w-auto transition-all duration-300 ease-in-out hover:opacity-80"
                                onerror="this.style.display='none'; const newText = document.createElement('span'); newText.className='text-xl font-bold text-blue-600 dark:text-blue-400'; newText.textContent='LEGNAXE'; this.parentNode.appendChild(newText);">
                    </a>
                </div>
                                <nav class="flex items-center space-x-2 sm:space-x-4 md:space-x-6 flex-nowrap overflow-x-auto">
                    <a href="index.html" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm sm:text-base font-medium transition-colors flex-shrink-0">IVS JSC Website</a>
                    <a href="author-about.html" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm sm:text-base font-medium transition-colors flex-shrink-0">About Author</a>
                    <a href="readnovel.html" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm sm:text-base font-medium transition-colors flex-shrink-0">Novel List</a>
                    <select id="language-toggle" aria-label="Select language" class="text-gray-700 dark:text-gray-300 bg-transparent border-none focus:outline-none text-sm sm:text-base font-medium flex-shrink-0">
                        <option value="en">English</option>
                        <option value="vi">Tiếng Việt</option>
                    </select>
                    <button id="theme-toggle" aria-label="Toggle light/dark mode" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-all duration-200 ease-in-out flex-shrink-0">
                        <i class="fas fa-moon text-xl"></i>
                    </button>
                </nav>
            </div>
        </header>

        <main class="w-full">
            <div class="main-content-wrapper py-8">
                <div class="page-content-container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

                    <h1 class="page-title text-3xl font-bold mb-6 text-gray-900 dark:text-white" data-lang-key="readnovel_title">Chọn Truyện Để Đọc</h1>

                    <div class="search-bar mb-6 border border-gray-300 dark:border-gray-600 rounded-md overflow-hidden bg-white dark:bg-gray-800">
                        <input type="text" id="searchInput" placeholder="Tìm kiếm truyện theo tên hoặc mô tả..." data-lang-key="readnovel_search_placeholder" class="w-full p-2 bg-transparent focus:outline-none placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white">
                    </div>

                    <div class="settings flex justify-end mb-4">
                        <button id="darkModeToggleButtonPage" aria-label="Chuyển chế độ Sáng/Tối" title="Chuyển chế độ Sáng/Tối" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-adjust text-xl"></i>
                    </button>
                </div>

                <div class="novel-list">

                    <div class="novel-card group bg-white dark:bg-gray-800 shadow-md hover:shadow-lg transition-shadow duration-200">
                        <a href="read-legnaxe_part1_vi.html" class="cover-link" aria-label="Đọc LEGNAXE Phần 1 Tiếng Việt">
                            <picture>
                                <source srcset="images/pages/novels/legnaxe1vertical.png" type="image/webp">
                                <img src="images/pages/novels/legnaxe1vertical.png" alt="Bìa truyện LEGNAXE Phần 1" class="book-cover bg-gray-200 dark:bg-gray-700" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/400x600/EBF4FF/4A5568?text=LEGNAXE+P1'; this.alt='Lỗi tải ảnh bìa LEGNAXE Phần 1';">
                            </picture>
                        </a>
                        <div class="card-content">
                            <h3 class="text-lg font-semibold line-clamp-1 mb-1 text-gray-900 dark:text-white" data-lang-key="readnovel_legnaxe1_title">LEGNAXE: Phần 1</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-4" data-lang-key="readnovel_legnaxe1_desc">Bí mật cuộc đại chiến Thiên Đàng / <strong>Secrets of Heaven's Great War.</strong></p>

                            <div class="story-item-content">
                                <div class="summary-container text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
                                     <p class="summary-short">
                                        Câu chuyện bắt đầu tại Thiên Đàng, nơi Lucifer, một Tổng lãnh Thiên thần, cảm thấy bất mãn với sự hoàn hảo đơn điệu và đặt nghi vấn về ý nghĩa tồn tại...
                                    </p>
                                    <div class="summary-full">
                                        <p>Câu chuyện bắt đầu tại Thiên Đàng, nơi Lucifer, một Tổng lãnh Thiên thần, cảm thấy bất mãn với sự hoàn hảo đơn điệu và đặt nghi vấn về ý nghĩa tồn tại...</p>
                                    </div>
                                     <a href="#" class="read-more-link text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mt-2 inline-block">Đọc thêm</a>
                                </div>
                            </div>

                             <div class="flex flex-col sm:flex-row gap-3 mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
                                <a href="read-legnaxe_part1_vi.html" class="read-button bg-blue-600 hover:bg-blue-700 text-white flex-1 py-2 rounded-md transition-colors">
                                    <i class="fas fa-book-open mr-2"></i> Đọc (TV)
                                </a>
                                <a href="read-legnaxe_part1_en.html" class="read-button bg-green-600 hover:bg-green-700 text-white flex-1 py-2 rounded-md transition-colors">
                                    <i class="fas fa-book-open mr-2"></i> Read (EN)
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="novel-card group bg-white dark:bg-gray-800 shadow-md hover:shadow-lg transition-shadow duration-200">
                        <a href="read-legnaxe_part2_vi.html" class="cover-link" aria-label="Đọc LEGNAXE Phần 2 Tiếng Việt">
                            <picture>
                                <source srcset="images/pages/novels/legnaxe2vertical.png" type="image/webp">
                                <img src="images/pages/novels/legnaxe2vertical.png" alt="Bìa truyện LEGNAXE Phần 2" class="book-cover bg-red-100 dark:bg-red-900" loading="lazy" onerror="this.onerror=null; this.src='https://placehold.co/400x600/FFF5F5/7F1D1D?text=LEGNAXE+P2'; this.alt='Lỗi tải ảnh bìa LEGNAXE Phần 2';">
                            </picture>
                        </a>
                        <div class="card-content">
                            <h3 class="text-lg font-semibold line-clamp-1 mb-1 text-gray-900 dark:text-white" data-lang-key="readnovel_legnaxe2_title">LEGNAXE: Phần 2 - Heavenly, Human's Heart</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-4" data-lang-key="readnovel_legnaxe2_desc_short">Hành trình khám phá Trần Gian và trái tim con người...</p>

                            <div class="story-item-content">
                                <div class="summary-container text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
                                    <p class="summary-short" data-lang-key="readnovel_legnaxe2_summary_short"></p>
                                        Hành trình khám phá Trần Gian và trái tim con người, nơi các thiên thần và con người đối mặt với những thử thách về niềm tin, tình yêu và sự hy sinh...
                                    </p>
                                    <div class="summary-full" data-lang-key="readnovel_legnaxe2_summary_full"></div>
                                        <p>Hành trình khám phá Trần Gian và trái tim con người...</p>
                                    </div>
                                     <a href="#" class="read-more-link text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mt-2 inline-block">Đọc thêm</a>
                                </div>
                            </div>

                            <p class="text-sm text-gray-700 dark:text-gray-300 mt-4 mb-2" data-lang-key="readnovel_choose_version"></p>
                                Chọn phiên bản để đọc: S1 và S2 diễn biến truyện bắt đầu thay đổi từ Chương 7. Độc giả có thể chọn tuyến truyện chính.
                            </p>
                            <div class="flex flex-wrap gap-3">
                                <a href="read-legnaxe_part2_vi.html" class="read-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-center transition-colors">
                                    <i class="fas fa-book-open mr-2"></i> Đọc (Tiếng Việt) S1
                                </a>
                                <a href="read-legnaxe_part2_en.html" class="read-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-center transition-colors">
                                    <i class="fas fa-book-open mr-2"></i> Read (English) S1
                                </a>
                                <a href="read-legnaxe_part2s_vi.html" class="read-button bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-center transition-colors"></a>
                                    <i class="fas fa-book-open mr-2"></i> Đọc (Tiếng Việt) S2
                                </a>
                                <a href="read-legnaxe_part2s_en.html" class="read-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-center transition-colors">
                                    <i class="fas fa-book-open mr-2"></i> Read (English) S2
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    </div> <div class="character-section mt-8 pt-8 border-t border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Khám phá các nhân vật trong LEGNAXE</h2>
                    <div class="flex flex-wrap gap-4">
                        <a href="legnaxeintheuniver.html" class="read-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-center transition-colors">
                            <i class="fas fa-users mr-2"></i> Xem Nhân Vật
                        </a>
                    </div>
                </div>

            </div> </div> </main>

        <footer id="footer-placeholder">
            <div class="w-full min-h-[60px] bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500 dark:text-gray-400 animate-pulse">
                Đang tải footer...
            </div>
            <div class="fetch-error-fallback hidden">
                <div class="bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-center p-4">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="mb-4">
                            <a href="/" class="text-lg font-semibold text-gray-700 dark:text-gray-300">IVS STEAM (Lỗi tải)</a>
                        </div>
                        <div class="flex justify-center space-x-4 mb-4 text-sm">
                            <a href="index.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Trang Chủ</a>
                            <a href="steambyivs.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">STEAM</a>
                            <a href="readnovel.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chọn Truyện</a>
                            <a href="contact.html" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Liên Hệ</a>
                        </div>
                        <div class="text-sm">
                            <p>© <span id="current-year-fallback">2024</span> IVS STEAM. All rights reserved.</p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    
            <button id="scroll-to-top-btn" title="Cuộn lên đầu trang">
                <i class="fas fa-arrow-up text-xl"></i>
            </button>
        </div>

        <script src="js/language.js" defer></script>
        <script>
            // --- Dark Mode Logic ---
            const htmlElement = document.documentElement;
            const darkModeToggleButtonPage = document.getElementById('darkModeToggleButtonPage');

            function applyInitialDarkMode() {
                const darkModePreference = localStorage.getItem('darkMode');
                if (darkModePreference === 'enabled' ||
                (!darkModePreference && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    htmlElement.classList.add('dark');
                } else {
                    htmlElement.classList.remove('dark');
                }
            }

            function toggleDarkMode() {
                const isDarkMode = htmlElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
                // Trigger a custom event after toggling to inform other components (like the header)
                const event = new CustomEvent('darkModeToggled', { detail: { isDarkMode } });
                window.dispatchEvent(event);
                console.log('Dark mode toggled:', isDarkMode); // Log toggle action
            }

            // Attach listener to the page-specific button if it exists
            if (darkModeToggleButtonPage) {
                darkModeToggleButtonPage.addEventListener('click', toggleDarkMode);
            }

            // Apply dark mode on initial load
            applyInitialDarkMode();

            // --- Search Functionality ---
            const searchInput = document.getElementById('searchInput');
            const novelCards = document.querySelectorAll('.novel-card');

            searchInput?.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                novelCards.forEach(card => {
                    const titleElement = card.querySelector('h3');
                    // Target both short and full summary for search
                    const shortDescElement = card.querySelector('.summary-short');
                    const fullSummaryElement = card.querySelector('.summary-full');

                    const title = titleElement ? titleElement.textContent.toLowerCase() : '';
                    const shortDesc = shortDescElement ? shortDescElement.textContent.toLowerCase() : '';
                    const fullSummary = fullSummaryElement ? fullSummaryElement.textContent.toLowerCase() : '';

                    // Check if term is in title, short desc, or full summary
                    const isVisible = title.includes(searchTerm) || shortDesc.includes(searchTerm) || fullSummary.includes(searchTerm);
                    card.style.display = isVisible ? '' : 'none'; // Use '' to revert to default display (grid item)
                });
            });

            // --- Read More Toggle Functionality ---
            document.addEventListener('DOMContentLoaded', () => {
                const readMoreLinks = document.querySelectorAll('.read-more-link');

                readMoreLinks.forEach(link => {
                    link.addEventListener('click', function(event) {
                        event.preventDefault(); // Prevent default anchor link behavior
                        const summaryContainer = this.closest('.summary-container');
                        if (summaryContainer) {
                            const shortSummary = summaryContainer.querySelector('.summary-short');
                            const fullSummary = summaryContainer.querySelector('.summary-full');
                            const isFullVisible = fullSummary.style.display !== 'none';

                            if (isFullVisible) {
                                fullSummary.style.display = 'none';
                                shortSummary.style.display = 'block'; // Ensure short is visible
                                this.textContent = 'Đọc thêm';
                            } else {
                                shortSummary.style.display = 'none';
                                fullSummary.style.display = 'block';
                                this.textContent = 'Thu gọn';
                            }
                        }
                    });
                });
            });


            // --- Scroll to Top Button ---
            const scrollToTopButton = document.getElementById('scroll-to-top-btn');
            const scrollThreshold = 300; // Pixels to scroll before showing the button

            if (scrollToTopButton) {
                scrollToTopButton.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                // Function to check scroll position and toggle button visibility
                const toggleScrollButtonVisibility = () => {
                    if (window.scrollY > scrollThreshold) {
                        scrollToTopButton.classList.add('visible');
                        scrollToTopButton.classList.remove('hidden'); // Ensure 'hidden' class is removed if previously added
                    } else {
                        scrollToTopButton.classList.remove('visible');
                        scrollToTopButton.classList.add('hidden'); // Add 'hidden' class for transitions
                    }
                };

                // Initial check on page load
                toggleScrollButtonVisibility();

                // Listen for scroll events
                window.addEventListener('scroll', toggleScrollButtonVisibility);
            }

            // --- Fetch Header and Footer ---
            document.addEventListener('DOMContentLoaded', function() {
                const headerPlaceholder = document.getElementById('header-placeholder');
                const footerPlaceholder = document.getElementById('footer-placeholder');
                const headerPath = 'header.html'; // Path to your header file
                const footerPath = 'footer.html'; // Path to your footer file

                // Handle fetch errors and display fallback content
                function handleFetchError(error, placeholderElement, type, filePath) {
                    console.error(`Error fetching ${type} from ${filePath}:`, error);
                    const pulseElement = placeholderElement.querySelector('.animate-pulse');
                    const fallbackElement = placeholderElement.querySelector('.fetch-error-fallback');

                    if (pulseElement) pulseElement.style.display = 'none'; // Hide loading pulse

                    if (fallbackElement) {
                        fallbackElement.classList.remove('hidden'); // Show fallback content
                        // Apply header-specific error class if necessary (already handled in HTML structure)
                    } else {
                        // Basic fallback if the structured fallback HTML is missing
                        const errorHtml = `<div class="fetch-error-message ${type}-error">Lỗi khi tải ${type}. Vui lòng tải lại trang.${type === 'header' ? ' <a href="/" class="ml-4 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Về Trang Chủ</a>' : ''}</div>`;
                        placeholderElement.innerHTML = errorHtml;
                        // Ensure header error styles are applied if created dynamically
                        if (type === 'header') {
                            const errorMsgDiv = placeholderElement.querySelector('.fetch-error-message');
                            if (errorMsgDiv) errorMsgDiv.classList.add('header-error');
                        }
                    }

                    // Ensure fallback year is set on footer error if that element exists
                    if(type === 'footer') {
                        const fallbackYearElement = placeholderElement.querySelector('#current-year-fallback');
                        if(fallbackYearElement) {
                            fallbackYearElement.textContent = new Date().getFullYear();
                        }
                    }
                    // Attempt to set active link on fallback header too
                    if(type === 'header') setActiveNavLink('readnovel.html');
                }

                // Fetch and inject HTML component
                function fetchComponent(placeholder, path, type) {
                    if (!placeholder) {
                        console.error(`${type} placeholder element not found.`);
                        // Still try to handle error display even if placeholder is null/undefined
                        if (document.getElementById(`${type}-placeholder`)) {
                            handleFetchError(new Error(`${type} placeholder element not found in DOM after script load`), document.getElementById(`${type}-placeholder`), type, path);
                        }
                        return Promise.reject(`${type} placeholder not found`);
                    }
                    return fetch(path)
                        .then(response => {
                            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                            return response.text();
                        })
                        .then(data => {
                            placeholder.innerHTML = data;
                            // Post-fetch tasks
                            if (type === 'header') {
                                // Set active navigation link after header content is loaded
                                setActiveNavLink('readnovel.html');
                                // Re-apply dark mode class to html element if needed (handled by applyInitialDarkMode on page load)
                                // Ensure dark mode toggle button in the loaded header works
                                const headerDarkModeButton = document.getElementById('darkModeToggleButtonHeader');
                                if (headerDarkModeButton) {
                                    // Ensure no duplicate listeners - best practice is to use a named function reference or a different approach if re-fetching
                                    // For simplicity here, assume fetch happens once or relies on the event listener from the main page script
                                    headerDarkModeButton.addEventListener('click', toggleDarkMode);
                                    console.log('Dark mode listener attached to loaded header button.');
                                }

                                // Apply translations if the function exists (from language.js)
                                if (typeof window.applyTranslations === 'function') {
                                    window.applyTranslations();
                                }
                                // Attach language switcher events if function exists (from language.js)
                                if (typeof window.attachLanguageSwitcherEvents === 'function') {
                                    window.attachLanguageSwitcherEvents();
                                }
                            }
                            if (type === 'footer') {
                                // Set current year in the footer
                                const currentYearElement = document.getElementById('current-year');
                                if (currentYearElement) {
                                    currentYearElement.textContent = new Date().getFullYear();
                                }
                                // Apply translations to footer
                                if (typeof window.applyTranslations === 'function') {
                                    window.applyTranslations();
                                }
                            }
                        })
                        .catch(error => handleFetchError(error, placeholder, type, path));
                }

                // Call fetchComponent after DOM is ready
                fetchComponent(headerPlaceholder, headerPath, 'header');
                fetchComponent(footerPlaceholder, footerPath, 'footer');

                // Initial language application (might be redundant if header/footer scripts also call it)
                // Keeping a slight delay in case header/footer scripts are still parsing/executing
                if (typeof window.applyTranslations === 'function') {
                    setTimeout(() => {
                        console.log("Attempting initial translation application after slight delay.");
                        window.applyTranslations();
                        // Also trigger update for any potential elements not in header/footer
                        const event = new CustomEvent('languageChanged', { detail: { lang: localStorage.getItem('preferredLanguage') || 'vi' } });
                        window.dispatchEvent(event);
                    }, 100);
                }
            });

            // Function to set active class on navigation links
            function setActiveNavLink(currentPageName) {
                // This function should ideally only run after the header is loaded.
                // It selects links within the header placeholder or the loaded header content.
                // We now target elements within the #header-placeholder *after* content is loaded.
                const headerContent = document.getElementById('header-placeholder');
                if (!headerContent) {
                    console.error("setActiveNavLink: Header placeholder not found.");
                    return;
                }
                // Selects main nav links and submenu links within the loaded header
                const navLinks = headerContent.querySelectorAll('a.nav-link, .submenu a, .mobile-submenu a');

                if (navLinks.length === 0) {
                    console.warn("setActiveNavLink: No navigation links found in loaded header content.");
                    // Attempt to style fallback link if it exists
                    const fallbackHomeLink = headerContent.querySelector('.fetch-error-message a[href="/"]');
                    if (fallbackHomeLink && currentPageName === 'index.html') { // Simple check for home page
                        fallbackHomeLink.classList.add('active-menu-item', 'bg-orange-600', 'text-white');
                        fallbackHomeLink.setAttribute('aria-current', 'page');
                    }
                    return;
                }

                navLinks.forEach(link => {
                    // Remove previously applied active classes
                    link.classList.remove('active-menu-item', 'active-parent-item', 'bg-orange-600', 'text-white', 'hover:bg-blue-600', 'dark:hover:bg-blue-400', 'transition-colors');
                    link.removeAttribute('aria-current');

                    let linkHref = link.getAttribute('href');
                    if (linkHref) {
                        // Normalize by removing leading/trailing slashes and .html
                        let normalizedLinkHref = linkHref.replace(/^\/+|\/+$/g, '').replace(/\.html$/, '');
                        if (normalizedLinkHref === "" || normalizedLinkHref === "index") normalizedLinkHref = "index";

                        let normalizedCurrentPageName = currentPageName.replace(/^\/+|\/+$/g, '').replace(/\.html$/, '');
                        if (normalizedCurrentPageName === "") normalizedCurrentPageName = "index";

                        if (normalizedLinkHref === normalizedCurrentPageName) {
                            link.classList.add('active-menu-item', 'bg-orange-600', 'text-white');
                            link.setAttribute('aria-current', 'page');

                            // Re-add hover styles for active item to provide feedback
                            link.classList.add('hover:bg-orange-700', 'dark:hover:bg-orange-700');


                            // Find parent menu items and mark them active (for dropdowns/mobile menus)
                            // Look for the closest ancestor with main-menu-item or mobile-menu-item class
                            let parentItem = link.closest('.main-menu-item, .mobile-menu-item');
                            while(parentItem){
                                // Find the button or link that acts as the parent trigger
                                const parentTrigger = parentItem.querySelector(':scope > button.nav-link, :scope > button.mobile-submenu-toggle, :scope > a.nav-link');
                                if(parentTrigger) {
                                    parentTrigger.classList.add('active-parent-item', 'bg-orange-600', 'text-white');
                                    parentTrigger.classList.add('hover:bg-orange-700', 'dark:hover:bg-orange-700'); // Add hover for active parent
                                }
                                // Move up to the next potential parent item
                                parentItem = parentItem.parentElement.closest('.main-menu-item, .mobile-menu-item');
                            }
                        } else {
                            // Ensure non-active links have default hover styles
                            link.classList.add('hover:text-blue-600', 'dark:hover:text-blue-400', 'transition-colors');
                        }
                    }
                });
            }
    </script>
</body>
</html>