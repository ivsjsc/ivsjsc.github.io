<header id="navbar" class="text-white shadow-md fixed top-0 left-0 right-0 z-[1001] transition-all duration-300 bg-gray-900 h-16"> {/* Increased z-index, added explicit height */}
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-full"> {/* Added h-full */}
        <div class="flex items-center justify-between h-full"> {/* Added h-full */}

            <div class="flex-shrink-0">
                <a href="/index.html" class="flex items-center" aria-label="Trang chủ IVS JSC">
                    <img class="h-10 w-auto rounded-md logo-img" /* Adjusted height if needed based on new header height */
                         src="/images/logo/logo1.png"
                         alt="IVS JSC Logo"
                         data-lang-key="logo_alt"
                         onerror="this.onerror=null; this.src='https://placehold.co/150x40/ffffff/F97316?text=IVS+Logo';">
                </a>
            </div>

            <nav class="hidden lg:flex lg:items-center lg:ml-6 h-full" aria-label="Main navigation"> {/* Added h-full */}
                <div class="flex items-center space-x-3 xl:space-x-4 h-full"> {/* Added h-full */}
                    <ul id="menu-items" class="flex items-center space-x-1 xl:space-x-2 h-full"> {/* Added h-full */}
                        <li class="main-menu-item h-full flex items-center"> {/* Added h-full flex items-center */}
                            <a href="/index.html" class="nav-link" data-lang-key="menu_home">Trang chủ</a>
                        </li>
                        <li class="relative main-menu-item group h-full flex items-center"> {/* Added h-full flex items-center */}
                            <button type="button" aria-haspopup="true" aria-expanded="false" class="nav-link inline-flex items-center desktop-menu-toggle">
                                <span data-lang-key="menu_about">Giới thiệu</span>
                                <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="submenu hidden group-hover:block group-focus-within:block"> {/* Simplified toggle with group-hover/focus-within for desktop */}
                                <a href="/about.html" data-lang-key="menu_about_ivs">Về chúng tôi</a>
                            </div>
                        </li>
                         <li class="relative main-menu-item group h-full flex items-center">
                            <button type="button" aria-haspopup="true" aria-expanded="false" class="nav-link inline-flex items-center desktop-menu-toggle">
                                <span data-lang-key="menu_services">Dịch vụ</span>
                                <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="submenu hidden group-hover:block group-focus-within:block">
                                <div class="sub-submenu-container group/sub relative"> {/* Added relative for positioning context */}
                                    <button type="button" aria-haspopup="true" aria-expanded="false" class="w-full inline-flex items-center justify-between desktop-submenu-toggle">
                                        <span data-lang-key="menu_utility_language_center">Tiện ích - TTNN</span>
                                        <svg class="ml-1 h-3.5 w-3.5 rotate-[-90deg]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div class="sub-submenu hidden group-hover/sub:block group-focus-within/sub:block">
                                        <a href="/ivslanguages.html" data-lang-key="menu_training_language">Đào tạo ngoại ngữ</a>
                                        <a href="/ivslifeminds.html" data-lang-key="menu_training_lifeskills">Đào tạo kỹ năng sống</a>
                                        <a href="/foreign-teacher-services.html" data-lang-key="menu_service_foreign_teacher">Giáo viên nước ngoài & Thủ tục</a>
                                        <a href="/thanhlaptrungtam.html" data-lang-key="menu_center_establishment">Thành lập Trung tâm</a>
                                        <a href="/rnd-curriculum.html" data-lang-key="menu_design_edu">Thiết kế Học liệu</a>
                                        <a href="/webdesign.html" data-lang-key="menu_web_design">Thiết kế Web</a>
                                    </div>
                                </div>
                                <div class="sub-submenu-container group/sub relative">
                                     <button type="button" aria-haspopup="true" aria-expanded="false" class="w-full inline-flex items-center justify-between desktop-submenu-toggle">
                                         <span data-lang-key="menu_educational_link">Liên kết giáo dục</span>
                                         <svg class="ml-1 h-3.5 w-3.5 rotate-[-90deg]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                     </button>
                                     <div class="sub-submenu hidden group-hover/sub:block group-focus-within/sub:block">
                                         <a href="/lkmamnon.html" data-lang-key="menu_link_preschool">Mầm non</a>
                                         <a href="/lktieuhoc.html" data-lang-key="menu_link_primary">Tiểu học</a>
                                         <a href="/lkthcsthpt.html" data-lang-key="menu_link_secondary">THCS & THPT</a>
                                     </div>
                                 </div>
                                 <div class="sub-submenu-container group/sub relative">
                                     <button type="button" aria-haspopup="true" aria-expanded="false" class="w-full inline-flex items-center justify-between desktop-submenu-toggle">
                                         <span data-lang-key="menu_training_teacher">Đào tạo giáo viên</span>
                                         <svg class="ml-1 h-3.5 w-3.5 rotate-[-90deg]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                     </button>
                                     <div class="sub-submenu hidden group-hover/sub:block group-focus-within/sub:block">
                                         <a href="/teachertrain.html" data-lang-key="menu_training_teacher_vn">Giáo viên VN</a>
                                         <a href="/fteachertrain.html" data-lang-key="menu_training_teacher_foreign">Giáo viên nước ngoài</a>
                                         <a href="/bosungchungchi.html" data-lang-key="menu_training_teacher_cert">Bổ sung chứng chỉ NVSP</a>
                                     </div>
                                 </div>
                                <hr class="my-1 border-gray-700"> {/* Use Tailwind's gray for consistency */}
                                <a href="/english-placement.html" data-lang-key="menu_placement_test">English Placement Test</a>
                            </div>
                        </li>
                        {/* Repeat for other main menu items, adding h-full flex items-center to li and group to li for hover effects */}
                        <li class="relative main-menu-item group h-full flex items-center">
                            <button type="button" aria-haspopup="true" aria-expanded="false" class="nav-link inline-flex items-center desktop-menu-toggle">
                                <span data-lang-key="menu_cooperation">Hợp tác</span>
                                <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="submenu hidden group-hover:block group-focus-within:block">
                                <div class="sub-submenu-container group/sub relative">
                                    <button type="button" aria-haspopup="true" aria-expanded="false" class="w-full inline-flex items-center justify-between desktop-submenu-toggle">
                                        <span data-lang-key="menu_cooperation_domestic">Trong nước</span>
                                        <svg class="ml-1 h-3.5 w-3.5 rotate-[-90deg]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div class="sub-submenu hidden group-hover/sub:block group-focus-within/sub:block">
                                        <a href="/hop-tac-dau-tu.html" data-lang-key="menu_investment_cooperation">Hợp tác Đầu tư</a>
                                        <a href="/philoinhuan.html" data-lang-key="menu_non_profit">Tổ chức Phi lợi nhuận</a>
                                        <a href="/tai-tro.html" data-lang-key="menu_sponsorship">Tài trợ</a>
                                    </div>
                                </div>
                                <div class="sub-submenu-container group/sub relative">
                                    <button type="button" aria-haspopup="true" aria-expanded="false" class="w-full inline-flex items-center justify-between desktop-submenu-toggle">
                                        <span data-lang-key="menu_cooperation_international">Quốc tế</span>
                                        <svg class="ml-1 h-3.5 w-3.5 rotate-[-90deg]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                                    </button>
                                    <div class="sub-submenu hidden group-hover/sub:block group-focus-within/sub:block">
                                        <a href="/lien-ket-quoc-te.html" data-lang-key="menu_international_link">Liên kết Quốc tế</a>
                                        <a href="/lienminhiivsa.html" data-lang-key="menu_iivsa_alliance">Liên minh Toàn Cầu IIVSA</a>
                                        <a href="/summercamp.html" data-lang-key="menu_summer_camp">Trại hè Quốc tế</a>
                                    </div>
                                </div>
                            </div>
                        </li>
                         <li class="relative main-menu-item group h-full flex items-center">
                             <button type="button" aria-haspopup="true" aria-expanded="false" class="nav-link inline-flex items-center desktop-menu-toggle">
                                 <span data-lang-key="menu_community">Cộng đồng</span>
                                 <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                             </button>
                             <div class="submenu hidden group-hover:block group-focus-within:block">
                                 <a href="/talktask-ivsuniversitieshcmc.html" data-lang-key="menu_community_student_club">CLB Sinh viên VN</a>
                                 <a href="/hay-noi.html" data-lang-key="menu_hay_noi_club">Chương trình "Hãy Nói"</a>
                                 <a href="/hocbong.html" data-lang-key="menu_scholarships">Học bổng Quốc tế</a>
                             </div>
                         </li>
                        <li class="relative main-menu-item group h-full flex items-center">
                            <button type="button" aria-haspopup="true" aria-expanded="false" class="nav-link inline-flex items-center desktop-menu-toggle">
                                <span data-lang-key="menu_healths">Sức khỏe</span>
                                <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                            </button>
                            <div class="submenu hidden group-hover:block group-focus-within:block">
                                <a href="/health-yensao.html" data-lang-key="menu_health_yensao">Yến sào Thanh Yến</a>
                                <a href="/health-luvyoga.html" data-lang-key="menu_health_luvyoga">LuvYoga Lộc Hòa </a>
                            </div>
                        </li>
                         <li class="relative main-menu-item group h-full flex items-center">
                             <button type="button" aria-haspopup="true" aria-expanded="false" class="nav-link inline-flex items-center desktop-menu-toggle">
                                 <span data-lang-key="menu_library">Thư viện</span>
                                 <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                             </button>
                             <div class="submenu hidden group-hover:block group-focus-within:block">
                                 <a href="/tailieugd.html" data-lang-key="menu_library_docs">Tài liệu giáo dục</a>
                                 <a href="/ivsmedia.html" data-lang-key="menu_library_media">IVSMedia</a>
                                 <a href="/readnovel.html" data-lang-key="menu_novels_docs">Kho Truyện</a>
                             </div>
                         </li>
                         <li class="relative main-menu-item group h-full flex items-center">
                             <button type="button" aria-haspopup="true" aria-expanded="false" class="nav-link inline-flex items-center desktop-menu-toggle">
                                 <span data-lang-key="menu_recruitment">Tuyển dụng</span>
                                 <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                             </button>
                             <div class="submenu hidden group-hover:block group-focus-within:block">
                                 <a href="/careervn.html" data-lang-key="menu_recruitment_vn">Tuyển dụng nội địa (VN)</a>
                                 <a href="/careerf.html" data-lang-key="menu_recruitment_intl">Tuyển dụng quốc tế (Intl)</a>
                             </div>
                         </li>
                        <li class="main-menu-item h-full flex items-center">
                            <a href="/contact.html" class="nav-link" data-lang-key="menu_contact">Liên hệ</a>
                        </li>
                    </ul>

                    <div class="flex items-center space-x-3 ml-4">
                        <button id="desktop-search-button" type="button" class="text-white p-2 rounded-full hover:bg-gray-700 focus:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-orange-400 transition duration-150 ease-in-out" aria-label="Tìm kiếm" data-lang-key="search_button_label_desktop">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                            <span class="sr-only" data-lang-key="search_sr_only_desktop">Tìm kiếm</span>
                        </button>

                        <div id="desktop-search-container" class="hidden items-center bg-gray-800 rounded-full transition-all duration-300 ease-in-out">
                            <form id="desktop-search-form" action="/search-results.html" method="GET" class="flex items-center w-full">
                                <input type="search" id="desktop-search-input" name="query"
                                       class="desktop-search-input w-48 sm:w-64 bg-transparent border-none text-white placeholder-gray-400 py-2 px-4 text-sm focus:outline-none focus:ring-0"
                                       placeholder="Tìm kiếm..." data-lang-key="search_placeholder_desktop" aria-label="Ô tìm kiếm">
                                <button type="submit" class="p-2 text-gray-400 hover:text-white" aria-label="Thực hiện tìm kiếm" data-lang-key="perform_search_label_desktop">
                                     <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                                </button>
                                <button type="button" id="desktop-search-close" class="desktop-search-close-btn p-2 text-gray-400 hover:text-white" aria-label="Đóng tìm kiếm" data-lang-key="close_search_label_desktop">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                </button>
                            </form>
                        </div>
                        
                        <button id="theme-toggle" type="button" class="text-white p-2 rounded-full hover:bg-gray-700 focus:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-orange-400 transition duration-150 ease-in-out" aria-label="Chuyển đổi giao diện">
                            <i class="fas fa-moon text-lg"></i> {/* Default icon */}
                            <span class="sr-only">Chuyển đổi giao diện</span>
                        </button>

                        <a href="/dangkytuvan.html" class="text-white px-4 py-1.5 rounded-full text-sm font-semibold transition duration-300 whitespace-nowrap bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-orange-400 cta-button" data-lang-key="consultation_cta_button">
                            Đăng Ký Tư vấn
                        </a>
                        <div id="desktop-language-dropdown" class="language-dropdown relative">
                            <button id="desktop-lang-toggle" type="button" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link inline-flex items-center">
                                <img id="desktop-current-lang-flag" src="/images/flags/vn.png" alt="VI" class="w-5 h-auto rounded-sm mr-1.5">
                                <span id="desktop-current-lang-text">VI</span>
                                <svg class="ml-1 h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"></path></svg>
                            </button>
                            <div id="desktop-lang-options" class="language-dropdown-content hidden absolute right-0 mt-2 w-auto bg-gray-800 rounded-md shadow-lg ring-1 ring-black ring-opacity-5 py-1 z-50">
                                <button type="button" class="lang-button w-full text-left px-3 py-1.5 text-sm text-white hover:bg-gray-700 flex items-center" data-lang="vi">
                                    <img src="/images/flags/vn.png" alt="Tiếng Việt" class="w-5 h-auto rounded-sm mr-2"> VN
                                </button>
                                <button type="button" class="lang-button w-full text-left px-3 py-1.5 text-sm text-white hover:bg-gray-700 flex items-center" data-lang="en">
                                   <img src="/images/flags/us.png" alt="English" class="w-5 h-auto rounded-sm mr-2"> EN
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="lg:hidden flex items-center">
                <button id="mobile-menu-button" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-orange-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu-panel" aria-expanded="false">
                    <span class="sr-only" data-lang-key="open_main_menu">Mở menu chính</span>
                    <svg id="icon-menu" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                    <svg id="icon-close" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="mobile-menu-overlay" class="hidden lg:hidden fixed inset-0 bg-gray-800/75 z-40 transition-opacity duration-300 ease-linear opacity-0" aria-hidden="true"></div>

    <div id="mobile-menu-panel" class="hidden lg:hidden fixed top-0 right-0 h-full w-72 max-w-[80vw] bg-white shadow-xl z-[1002] transform transition-transform duration-300 ease-in-out translate-x-full flex flex-col" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-heading">
        <div id="mobile-header" class="flex items-center justify-between px-4 py-3 border-b border-gray-200 flex-shrink-0">
            <h2 id="mobile-menu-heading" class="sr-only">Mobile Navigation Menu</h2>
            <a href="/index.html" class="flex items-center" aria-label="Trang chủ IVS JSC">
                <img class="h-8 w-auto rounded-sm logo-img-mobile" src="/images/logo/logo.png" alt="IVS JSC Logo Mobile" data-lang-key="logo_alt_mobile" onerror="this.onerror=null; this.src='https://placehold.co/100x32/ea580c/ffffff?text=IVS';">
            </a>
            <button id="mobile-close-button" type="button" class="p-1 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-orange-500" aria-label="Đóng menu" data-lang-key="close_menu">
                <span class="sr-only" data-lang-key="close_menu_sr">Đóng menu</span>
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <nav id="mobile-menu-content" class="flex-grow overflow-y-auto py-2 px-2 space-y-1" aria-label="Mobile navigation">
            <div class="px-1 pt-2 pb-2">
                <form id="mobile-search-form" action="/search-results.html" method="GET" class="relative">
                    <label for="mobile-search-input" class="sr-only" data-lang-key="search_label_mobile">Tìm kiếm</label>
                    <input type="search" name="query" id="mobile-search-input" class="block w-full rounded-md border-gray-300 pl-3 pr-10 py-2 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Tìm kiếm..." data-lang-key="search_placeholder_mobile" aria-label="Ô tìm kiếm di động">
                    <button type="submit" aria-label="Thực hiện tìm kiếm" data-lang-key="perform_search_label_mobile" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-orange-500">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </form>
            </div>

            <a href="/index.html" class="nav-link block text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3" data-lang-key="menu_home">Trang chủ</a>
            <div class="mobile-menu-item">
                <button type="button" aria-expanded="false" aria-controls="mobile-submenu-about" class="mobile-submenu-toggle w-full flex items-center justify-between text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3">
                    <span data-lang-key="menu_about">Giới thiệu</span>
                    <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                </button>
                <div id="mobile-submenu-about" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                    <a href="/about.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_about_ivs">Về chúng tôi</a>
                </div>
            </div>
            <div class="mobile-menu-item">
                <button type="button" aria-expanded="false" aria-controls="mobile-submenu-services-new" class="mobile-submenu-toggle w-full flex items-center justify-between text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3">
                    <span data-lang-key="menu_services">Dịch vụ</span>
                    <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                </button>
                <div id="mobile-submenu-services-new" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                    <div class="mobile-menu-item">
                        <button type="button" aria-expanded="false" aria-controls="mobile-subsubmenu-utility-ttnn" class="mobile-submenu-toggle w-full flex items-center justify-between text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3">
                            <span data-lang-key="menu_utility_language_center">Tiện ích - TTNN</span>
                            <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="mobile-subsubmenu-utility-ttnn" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                            <a href="/ivslanguages.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_training_language">Đào tạo ngoại ngữ</a>
                            <a href="/ivslifeminds.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_training_lifeskills">Đào tạo kỹ năng sống</a>
                            <a href="/foreign-teacher-services.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_service_foreign_teacher">Giáo viên nước ngoài & Thủ tục</a>
                            <a href="/thanhlaptrungtam.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_center_establishment">Thành lập Trung tâm</a>
                            <a href="/rnd-curriculum.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_design_edu">Thiết kế Học liệu</a>
                            <a href="/webdesign.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_web_design">Thiết kế Web</a>
                        </div>
                    </div>
                    <div class="mobile-menu-item">
                         <button type="button" aria-expanded="false" aria-controls="mobile-subsubmenu-edu-link-new" class="mobile-submenu-toggle w-full flex items-center justify-between text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3">
                             <span data-lang-key="menu_educational_link">Liên kết giáo dục</span>
                             <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                         </button>
                         <div id="mobile-subsubmenu-edu-link-new" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                             <a href="/lkmamnon.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_link_preschool">Mầm non</a>
                             <a href="/lktieuhoc.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_link_primary">Tiểu học</a>
                             <a href="/lkthcsthpt.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_link_secondary">THCS & THPT</a>
                         </div>
                    </div>
                    <div class="mobile-menu-item">
                         <button type="button" aria-expanded="false" aria-controls="mobile-subsubmenu-teacher-training-new" class="mobile-submenu-toggle w-full flex items-center justify-between text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3">
                             <span data-lang-key="menu_training_teacher">Đào tạo giáo viên</span>
                             <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" /></svg>
                         </button>
                         <div id="mobile-subsubmenu-teacher-training-new" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                             <a href="/teachertrain.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_training_teacher_vn">Giáo viên VN</a>
                             <a href="/fteachertrain.html" class="nav-link block text-xs text-gray-500 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1 px-3" data-lang-key="menu_training_teacher_foreign">Giáo viên nước ngoài</a>
                             <a href="/bosungchungchi.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_training_teacher_cert">Bổ sung chứng chỉ NVSP</a>
                         </div>
                    </div>
                     <a href="/english-placement.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_placement_test">English Placement Test</a>
                 </div>
            </div>
            {/* ... (Thêm các mục menu cha khác tương tự như trên cho Hợp tác, Cộng đồng, Sức khỏe, Thư viện, Tuyển dụng) ... */}
             <div class="mobile-menu-item">
                <button type="button" aria-expanded="false" aria-controls="mobile-submenu-coop" class="mobile-submenu-toggle w-full flex items-center justify-between text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3">
                    <span data-lang-key="menu_cooperation">Hợp tác</span>
                    <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"></path></svg>
                </button>
                <div id="mobile-submenu-coop" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                    {/* Sub-submenus for Hợp tác */}
                </div>
            </div>
            <div class="mobile-menu-item">
                <button type="button" aria-expanded="false" aria-controls="mobile-submenu-community" class="mobile-submenu-toggle w-full flex items-center justify-between text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3">
                    <span data-lang-key="menu_community">Cộng đồng</span>
                    <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"></path></svg>
                </button>
                <div id="mobile-submenu-community" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                     <a href="/talktask-ivsuniversitieshcmc.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_community_student_club">CLB Sinh viên VN</a>
                    <a href="/hay-noi.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_hay_noi_club">Chương trình "Hãy Nói"</a>
                    <a href="/hocbong.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_scholarships">Học bổng Quốc tế</a>
                </div>
            </div>
             <div class="mobile-menu-item">
                <button type="button" aria-expanded="false" aria-controls="mobile-submenu-health" class="mobile-submenu-toggle w-full flex items-center justify-between text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3">
                    <span data-lang-key="menu_healths">Sức khỏe</span>
                    <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"></path></svg>
                </button>
                <div id="mobile-submenu-health" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                     <a href="/health-yensao.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_health_yensao">Yến sào Thanh Yến</a>
                    <a href="/health-luvyoga.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_health_luvyoga">LuvYoga Lộc Hòa </a>
                </div>
            </div>
            <div class="mobile-menu-item">
                 <button type="button" aria-expanded="false" aria-controls="mobile-submenu-library" class="mobile-submenu-toggle w-full flex items-center justify-between text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3">
                     <span data-lang-key="menu_library">Thư viện</span>
                     <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"></path></svg>
                 </button>
                 <div id="mobile-submenu-library" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                      <a href="/tailieugd.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_library_docs">Tài liệu giáo dục</a>
                     <a href="/ivsmedia.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_library_media">IVSMedia</a>
                     <a href="/readnovel.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_novels_docs">Kho Truyện</a>
                 </div>
            </div>
             <div class="mobile-menu-item">
                 <button type="button" aria-expanded="false" aria-controls="mobile-submenu-recruitment" class="mobile-submenu-toggle w-full flex items-center justify-between text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3">
                     <span data-lang-key="menu_recruitment">Tuyển dụng</span>
                     <svg class="ml-1 h-4 w-4 transform submenu-arrow text-gray-400 group-hover:text-gray-500 transition-transform duration-150" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.19 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"></path></svg>
                 </button>
                 <div id="mobile-submenu-recruitment" class="mobile-submenu space-y-1 pl-3 mt-1" style="max-height: 0px; overflow: hidden;">
                     <a href="/careervn.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_recruitment_vn">Tuyển dụng nội địa (VN)</a>
                     <a href="/careerf.html" class="nav-link block text-sm text-gray-600 hover:bg-gray-100 hover:text-gray-900 rounded-md py-1.5 px-3" data-lang-key="menu_recruitment_intl">Tuyển dụng quốc tế (Intl)</a>
                 </div>
            </div>

            <a href="/contact.html" class="nav-link block text-base font-medium text-gray-700 hover:bg-gray-100 hover:text-gray-900 rounded-md py-2 px-3" data-lang-key="menu_contact">Liên hệ</a>
        </nav>

        <div id="mobile-footer" class="p-4 border-t border-gray-200 flex-shrink-0">
             <button id="theme-toggle-mobile" type="button" class="w-full flex items-center justify-center text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-md p-2 mb-2" aria-label="Chuyển đổi giao diện">
                 <i class="fas fa-moon mr-2 text-lg"></i> 
                 <span data-lang-key="theme_toggle_text_mobile">Chế độ tối</span>
            </button>
            <div id="mobile-language-dropdown" class="language-dropdown relative w-full">
                <button id="mobile-lang-toggle" type="button" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-md p-2">
                    <div class="flex items-center">
                        <img id="mobile-current-lang-flag" src="/images/flags/vn.png" alt="VI" class="w-5 h-auto rounded-sm mr-2">
                        <span id="mobile-current-lang-text">VI</span>
                    </div>
                    <svg class="ml-1 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.23 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
                </button>
                <div id="mobile-lang-options" class="language-dropdown-content hidden absolute bottom-full left-0 right-0 mb-1 w-full bg-white shadow-lg rounded-md border border-gray-200 overflow-hidden z-10">
                    <button type="button" class="lang-button w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" data-lang="vi">
                        <img src="/images/flags/vn.png" alt="Tiếng Việt" class="w-5 h-auto rounded-sm mr-2"> VN
                    </button>
                    <button type="button" class="lang-button w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center" data-lang="en">
                       <img  src="/images/flags/us.png" alt="English" class="w-5 h-auto rounded-sm mr-2"> EN
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
// This script should ideally be part of the loaded header.html component.
// If script.js is loading header.html, this script will execute after header.html is injected.
document.addEventListener('DOMContentLoaded', function () {
    const headerElement = document.getElementById('navbar'); // Main header element
    if (!headerElement) {
        console.error("[HeaderScript] Navbar element not found. Header script aborted.");
        return;
    }

    // --- Cache Header Elements ---
    const mobileMenuButton = headerElement.querySelector('#mobile-menu-button');
    const mobileMenuPanel = headerElement.querySelector('#mobile-menu-panel');
    const mobileMenuOverlay = headerElement.querySelector('#mobile-menu-overlay');
    const iconMenu = headerElement.querySelector('#icon-menu');
    const iconClose = headerElement.querySelector('#icon-close');
    const mobileCloseButton = headerElement.querySelector('#mobile-close-button');
    const desktopMenuItems = headerElement.querySelectorAll('#menu-items > .main-menu-item');
    const desktopSearchButton = headerElement.querySelector('#desktop-search-button');
    const desktopSearchContainer = headerElement.querySelector('#desktop-search-container');
    const desktopSearchInput = headerElement.querySelector('#desktop-search-input');
    const desktopSearchClose = headerElement.querySelector('#desktop-search-close');
    const desktopThemeToggle = headerElement.querySelector('#theme-toggle'); // Desktop theme toggle in header
    const mobileThemeToggle = headerElement.querySelector('#theme-toggle-mobile'); // Mobile theme toggle in panel
    const consultationButton = headerElement.querySelector('.cta-button');
    const desktopLangToggle = headerElement.querySelector('#desktop-lang-toggle');
    const desktopLangOptions = headerElement.querySelector('#desktop-lang-options');
    const mobileLangToggle = headerElement.querySelector('#mobile-lang-toggle');
    const mobileLangOptions = headerElement.querySelector('#mobile-lang-options');


    // --- Mobile Menu Logic ---
    function setupMobileMenu() {
        if (!mobileMenuButton || !mobileMenuPanel || !mobileMenuOverlay || !iconMenu || !iconClose || !mobileCloseButton) {
            console.warn("[HeaderScript] Mobile menu core elements not all found. Mobile menu might not function fully.");
            return;
        }

        const toggleMobileMenu = (forceOpenState) => {
            const isCurrentlyExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
            const shouldBeOpen = typeof forceOpenState === 'boolean' ? forceOpenState : !isCurrentlyExpanded;

            mobileMenuButton.setAttribute('aria-expanded', String(shouldBeOpen));
            iconMenu.classList.toggle('hidden', shouldBeOpen);
            iconClose.classList.toggle('hidden', !shouldBeOpen);

            if (shouldBeOpen) {
                mobileMenuOverlay.classList.remove('hidden');
                mobileMenuPanel.classList.remove('hidden'); // Make it visible before transform
                requestAnimationFrame(() => { // Allow repaint before transition
                    mobileMenuOverlay.classList.remove('opacity-0'); // Start transition for overlay
                    mobileMenuPanel.classList.remove('translate-x-full'); // Start transition for panel
                });
                document.body.classList.add('overflow-hidden');
            } else {
                mobileMenuOverlay.classList.add('opacity-0');
                mobileMenuPanel.classList.add('translate-x-full');
                const transitionEndHandler = () => {
                    if (mobileMenuPanel.classList.contains('translate-x-full')) { // Check if it's truly closed
                        mobileMenuPanel.classList.add('hidden');
                        mobileMenuOverlay.classList.add('hidden');
                    }
                    mobileMenuPanel.removeEventListener('transitionend', transitionEndHandler);
                };
                mobileMenuPanel.addEventListener('transitionend', transitionEndHandler);
                // Fallback timeout
                setTimeout(() => {
                    if (mobileMenuPanel.classList.contains('translate-x-full')) {
                         mobileMenuPanel.classList.add('hidden');
                         mobileMenuOverlay.classList.add('hidden');
                    }
                }, 350); // Slightly longer than transition duration
                document.body.classList.remove('overflow-hidden');
            }
        };

        mobileMenuButton.addEventListener('click', () => toggleMobileMenu());
        mobileCloseButton.addEventListener('click', () => toggleMobileMenu(false));
        mobileMenuOverlay.addEventListener('click', () => toggleMobileMenu(false));

        mobileMenuPanel.querySelectorAll('a[href]:not(.mobile-submenu-toggle)').forEach(link => {
            if (!link.closest('.mobile-submenu-toggle')) { // Ensure it's not part of a toggle button
                 link.addEventListener('click', () => setTimeout(() => toggleMobileMenu(false), 150));
            }
        });

        // Accordion for mobile submenus
        const mobileSubmenuItems = mobileMenuPanel.querySelectorAll('.mobile-menu-item');
        mobileSubmenuItems.forEach(item => {
            const button = item.querySelector(':scope > button.mobile-submenu-toggle');
            const submenu = item.querySelector(':scope > .mobile-submenu');
            const arrow = button?.querySelector('.submenu-arrow');

            if (button && submenu) {
                // Initial setup
                submenu.style.maxHeight = '0px';
                submenu.style.overflow = 'hidden';
                button.setAttribute('aria-expanded', 'false');
                if (arrow) arrow.classList.remove('rotate-90');


                button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const parentItem = this.closest('.mobile-menu-item'); // `this` is the button
                    const isOpen = parentItem.classList.toggle('open');
                    this.setAttribute('aria-expanded', String(isOpen));
                    if (arrow) arrow.classList.toggle('rotate-90', isOpen);

                    if (isOpen) {
                        submenu.style.maxHeight = submenu.scrollHeight + "px";
                        // Optional: Set overflow to visible after transition for content that might need it.
                        // submenu.addEventListener('transitionend', () => { if(isOpen) submenu.style.overflow = 'visible'; }, {once: true});


                        // Close other sibling .mobile-menu-item elements at the same level
                        const siblings = Array.from(parentItem.parentNode.children)
                            .filter(child => child !== parentItem && child.classList.contains('mobile-menu-item') && child.classList.contains('open'));

                        siblings.forEach(sibling => {
                            sibling.classList.remove('open');
                            const siblingSubmenu = sibling.querySelector(':scope > .mobile-submenu');
                            const siblingButton = sibling.querySelector(':scope > button.mobile-submenu-toggle');
                            const siblingArrow = siblingButton?.querySelector('.submenu-arrow');

                            if (siblingSubmenu) {
                                siblingSubmenu.style.maxHeight = '0px';
                                siblingSubmenu.style.overflow = 'hidden';
                            }
                            if (siblingButton) siblingButton.setAttribute('aria-expanded', 'false');
                            if (siblingArrow) siblingArrow.classList.remove('rotate-90');
                        });
                    } else {
                        submenu.style.maxHeight = '0px';
                        submenu.style.overflow = 'hidden'; // Ensure hidden on close
                        // Also collapse any nested submenus within this one if it's closed
                        parentItem.querySelectorAll('.mobile-menu-item.open').forEach(nestedOpenItem => {
                             nestedOpenItem.classList.remove('open');
                             const nestedSubmenu = nestedOpenItem.querySelector(':scope > .mobile-submenu');
                             const nestedButton = nestedOpenItem.querySelector(':scope > button.mobile-submenu-toggle');
                             const nestedArrow = nestedButton?.querySelector('.submenu-arrow');
                             if(nestedSubmenu) {
                                 nestedSubmenu.style.maxHeight = '0px';
                                 nestedSubmenu.style.overflow = 'hidden';
                             }
                             if(nestedButton) nestedButton.setAttribute('aria-expanded', 'false');
                             if(nestedArrow) nestedArrow.classList.remove('rotate-90');
                        });
                    }
                });
            }
        });
    }
    setupMobileMenu();


    // --- Desktop Menu Logic (Hover/Focus for Tailwind) ---
    // Using Tailwind's group-hover and group-focus-within for pure CSS dropdowns on desktop.
    // The JS part is mainly to ensure aria-expanded attributes are set for accessibility if using buttons.
    // If using <a> tags for main menu items that open submenus, this JS needs adjustment or can be removed.
    function setupDesktopMenus() {
        desktopMenuItems.forEach(item => {
            const toggleButton = item.querySelector('.desktop-menu-toggle'); // Assuming dropdowns are toggled by buttons
            const submenu = item.querySelector('.submenu');

            if (toggleButton && submenu) {
                // For click-to-toggle (if not using pure CSS hover)
                toggleButton.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';

                    // Close other open main menus first
                    desktopMenuItems.forEach(otherItem => {
                        if (otherItem !== item) {
                            otherItem.querySelector('.submenu')?.classList.add('hidden');
                            otherItem.querySelector('.submenu')?.classList.remove('open'); // For CSS transitions
                            otherItem.querySelector('.desktop-menu-toggle')?.setAttribute('aria-expanded', 'false');
                            otherItem.querySelector('.desktop-menu-toggle')?.classList.remove('active');
                        }
                    });
                    
                    submenu.classList.toggle('hidden', isExpanded);
                    requestAnimationFrame(() => submenu.classList.toggle('open', !isExpanded));
                    this.setAttribute('aria-expanded', String(!isExpanded));
                    this.classList.toggle('active', !isExpanded);
                });

                // Sub-submenus
                submenu.querySelectorAll('.sub-submenu-container').forEach(container => {
                    const subToggleButton = container.querySelector('.desktop-submenu-toggle');
                    const subSubmenu = container.querySelector('.sub-submenu');
                    if (subToggleButton && subSubmenu) {
                        subToggleButton.addEventListener('click', function(event) {
                            event.stopPropagation();
                            const isSubExpanded = this.getAttribute('aria-expanded') === 'true';
                             // Close other open sub-submenus within the same parent submenu
                            submenu.querySelectorAll('.sub-submenu-container').forEach(otherContainer => {
                                if (otherContainer !== container) {
                                    otherContainer.querySelector('.sub-submenu')?.classList.add('hidden');
                                    otherContainer.querySelector('.sub-submenu')?.classList.remove('open');
                                    otherContainer.querySelector('.desktop-submenu-toggle')?.setAttribute('aria-expanded', 'false');
                                }
                            });

                            subSubmenu.classList.toggle('hidden', isSubExpanded);
                             requestAnimationFrame(() => subSubmenu.classList.toggle('open', !isSubExpanded));
                            this.setAttribute('aria-expanded', String(!isSubExpanded));
                        });
                    }
                });
            } else if (item.classList.contains('group')) {
                 // If using Tailwind group-hover, ensure parent `li` has `relative` and submenu `absolute`
                 // No JS needed for hover itself, but managing focus for accessibility might be added
                 item.addEventListener('focusin', () => {
                    item.querySelector('.submenu')?.classList.remove('hidden');
                    item.querySelector('.submenu')?.classList.add('open'); // For transition
                 });
                 item.addEventListener('focusout', (e) => {
                    if (!item.contains(e.relatedTarget)) {
                        item.querySelector('.submenu')?.classList.add('hidden');
                        item.querySelector('.submenu')?.classList.remove('open');
                    }
                 });

                 submenu?.querySelectorAll('.sub-submenu-container.group\\/sub').forEach(subContainer => {
                    subContainer.addEventListener('focusin', () => {
                        subContainer.querySelector('.sub-submenu')?.classList.remove('hidden');
                        subContainer.querySelector('.sub-submenu')?.classList.add('open');
                    });
                    subContainer.addEventListener('focusout', (e) => {
                        if (!subContainer.contains(e.relatedTarget)) {
                             subContainer.querySelector('.sub-submenu')?.classList.add('hidden');
                             subContainer.querySelector('.sub-submenu')?.classList.remove('open');
                        }
                    });
                 });
            }
        });
        // Close all desktop dropdowns if clicked outside
        document.addEventListener('click', (event) => {
            let clickedInsideADesktopMenu = false;
            desktopMenuItems.forEach(item => {
                if (item.contains(event.target)) {
                    clickedInsideADesktopMenu = true;
                }
            });
            if (!clickedInsideADesktopMenu) {
                 desktopMenuItems.forEach(item => {
                    item.querySelector('.submenu')?.classList.add('hidden');
                    item.querySelector('.submenu')?.classList.remove('open');
                    item.querySelector('.desktop-menu-toggle')?.setAttribute('aria-expanded', 'false');
                    item.querySelector('.desktop-menu-toggle')?.classList.remove('active');
                 });
            }
        });
    }
    // If using pure CSS hover/focus-within for desktop menus (Tailwind group-*), 
    // the JS above for click might not be necessary or could be simplified for ARIA only.
    // The provided HTML structure uses 'group' which suggests hover/focus for submenus.
    // I've adjusted to reflect this possibility, keeping click logic for toggles if they are buttons.
    // If main menu items are <a> tags that also toggle, the event listeners need to target those.
    // For simplicity, the provided HTML now uses 'group' and 'group-hover:block' on submenus. JS for aria-attributes is good.
    // The more complex click handling for desktop menus is kept for now as it was in original script.
    if (desktopMenuItems.length > 0) setupDesktopMenus();


    // --- Desktop Search Logic ---
    function setupDesktopSearch() {
        if (!desktopSearchButton || !desktopSearchContainer || !desktopSearchInput || !desktopSearchClose) {
            console.warn("[HeaderScript] Desktop search elements not found.");
            return;
        }
        const elementsToHide = [consultationButton, desktopLangToggle, desktopThemeToggle].filter(el => el);

        const toggleSearchVisibility = (show) => {
            desktopSearchContainer.classList.toggle('hidden', !show);
            desktopSearchContainer.classList.toggle('flex', show); // Use flex for layout
            desktopSearchButton.classList.toggle('hidden', show);
            elementsToHide.forEach(el => el.classList.toggle('hidden', show));
        };

        desktopSearchButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSearchVisibility(true);
            desktopSearchInput.focus();
            // Close desktop menus if open
             desktopMenuItems.forEach(item => {
                item.querySelector('.submenu')?.classList.add('hidden');
                item.querySelector('.submenu')?.classList.remove('open');
                item.querySelector('.desktop-menu-toggle')?.setAttribute('aria-expanded', 'false');
             });
        });
        desktopSearchClose.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSearchVisibility(false);
            desktopSearchInput.value = '';
        });
        desktopSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') toggleSearchVisibility(false);
        });
        // Prevent closing when clicking inside search bar
        desktopSearchContainer.addEventListener('click', e => e.stopPropagation());
        // Close search if clicking outside
        document.addEventListener('click', (e) => {
            if (!desktopSearchContainer.classList.contains('hidden') && !desktopSearchContainer.contains(e.target) && e.target !== desktopSearchButton) {
                toggleSearchVisibility(false);
            }
        });
    }
    setupDesktopSearch();

    // --- Language Dropdown Logic (Desktop and Mobile) ---
    function setupLanguageDropdown(toggleBtn, optionsDiv) {
        if (!toggleBtn || !optionsDiv) return;

        toggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
            optionsDiv.classList.toggle('hidden', isExpanded);
            optionsDiv.classList.toggle('show', !isExpanded); // For transition
            toggleBtn.setAttribute('aria-expanded', String(!isExpanded));
            toggleBtn.classList.toggle('active', !isExpanded);
        });

        optionsDiv.querySelectorAll('.lang-button').forEach(button => {
            button.addEventListener('click', function() {
                const lang = this.dataset.lang;
                if (typeof window.setLanguage === 'function') {
                    window.setLanguage(lang);
                } else {
                    console.warn("[HeaderScript] window.setLanguage function is not available.");
                }
                // Close dropdown
                optionsDiv.classList.add('hidden');
                optionsDiv.classList.remove('show');
                toggleBtn.setAttribute('aria-expanded', 'false');
                toggleBtn.classList.remove('active');
            });
        });
    }

    if (desktopLangToggle && desktopLangOptions) {
         setupLanguageDropdown(desktopLangToggle, desktopLangOptions);
    }
    if (mobileLangToggle && mobileLangOptions) {
        setupLanguageDropdown(mobileLangToggle, mobileLangOptions);
    }
    // Global click to close language dropdowns
    document.addEventListener('click', () => {
        [desktopLangOptions, mobileLangOptions].forEach(options => {
            if (options && !options.classList.contains('hidden')) {
                options.classList.add('hidden');
                options.classList.remove('show');
                const toggle = options.id === 'desktop-lang-options' ? desktopLangToggle : mobileLangToggle;
                if (toggle) {
                    toggle.setAttribute('aria-expanded', 'false');
                    toggle.classList.remove('active');
                }
            }
        });
    });


    // --- Theme Toggle Setup (using shared function) ---
    function setupThemeToggleInHeader(buttonId, scope = document) {
        const themeToggleButton = scope.querySelector(`#${buttonId}`);
        if (!themeToggleButton) return;

        const iconElement = themeToggleButton.querySelector('i');
        const textElement = buttonId === 'theme-toggle-mobile' ? themeToggleButton.querySelector('span:not(.sr-only)') : null;

        function updateButtonUI(theme) {
            const isDark = theme === 'dark';
            if (iconElement) {
                iconElement.classList.toggle('fa-sun', isDark);
                iconElement.classList.toggle('fa-moon', !isDark);
            }
            if (textElement) { // For mobile button
                const key = isDark ? "theme_toggle_light_mobile" : "theme_toggle_dark_mobile"; // More specific keys
                let buttonText = isDark ? "Chế độ sáng" : "Chế độ tối";
                if (typeof window.getTranslation === 'function') { // Assumes getTranslation exists
                    buttonText = window.getTranslation(key, buttonText);
                }
                textElement.textContent = buttonText;
            }
            themeToggleButton.setAttribute('aria-label', isDark ? (window.getTranslation?.('aria_switch_light', 'Chuyển sang chế độ sáng') || 'Chuyển sang chế độ sáng')
                                                                 : (window.getTranslation?.('aria_switch_dark', 'Chuyển sang chế độ tối') || 'Chuyển sang chế độ tối'));
        }

        // Initial theme application
        let currentTheme = localStorage.getItem("theme");
        if (!currentTheme) { // If no theme in localStorage, check system preference
            currentTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        document.documentElement.classList.remove('light', 'dark'); // Clean slate
        document.documentElement.classList.add(currentTheme); // Apply to HTML tag
        updateButtonUI(currentTheme);

        themeToggleButton.addEventListener("click", () => {
            let newTheme = document.documentElement.classList.contains("dark") ? "light" : "dark";
            document.documentElement.classList.remove("light", "dark");
            document.documentElement.classList.add(newTheme);
            localStorage.setItem("theme", newTheme);
            updateButtonUI(newTheme);
        });
    }
    if (desktopThemeToggle) setupThemeToggleInHeader('theme-toggle', headerElement);
    if (mobileThemeToggle) setupThemeToggleInHeader('theme-toggle-mobile', headerElement);


    // --- Sticky Navbar ---
    const navbar = headerElement; // The main header element is the navbar
    const shrinkThreshold = 50;
    const handleScroll = () => {
        navbar.classList.toggle('shrinked', window.scrollY > shrinkThreshold);
    };
    window.addEventListener('scroll', debounce(handleScroll, 10), { passive: true });
    handleScroll(); // Initial check

    console.log("[HeaderScript] Header internal script initialized.");
});
</script>