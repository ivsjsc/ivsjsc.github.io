<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEGNAXE: Bí Mật Cuộc Đại Chiến Thiên Đàng (Phần 1 - Tiếng Việt)</title>
    <meta name="description" content="LEGNAXE Phần 1: Bí Mật Cuộc Đại Chiến Thiên Đàng - Khám phá nguồn gốc xung đột giữa các thiên thần, sự ra đời của loài người và những lựa chọn định mệnh.">
    <meta property="og:title" content="LEGNAXE: Bí Mật Cuộc Đại Chiến Thiên Đàng (Phần 1)">
    <meta property="og:description" content="Đọc truyện LEGNAXE Phần 1, tìm hiểu về sự kiện dẫn đến cuộc chiến vĩ đại trên Thiên Đàng.">
    <meta property="og:image" content="https://placehold.co/1200x630/8B5CF6/FFFFFF?text=LEGNAXE">
    <meta property="og:url" content="https://ivs.id.vn/legnaxe_part1_vi.html"> <meta property="og:type" content="article">
    <meta property="article:section" content="Truyện Dài">
    <meta property="article:author" content="Nguyen Minh Triet">

    <link rel="icon" href="https://placehold.co/32x32/8B5CF6/FFFFFF?text=L" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: { // Giữ lại các màu đã định nghĩa, Tailwind sẽ ưu tiên class trực tiếp
                        'primary': '#3b82f6',      // blue-500
                        'primary-dark': '#2563eb', // blue-600
                        'blue-400': '#60a5fa',     // Dùng cho text/link ở dark mode
                        'blue-600': '#2563eb',     // Dùng cho button ở light mode
                        'blue-700': '#1d4ed8',     // Dùng cho button hover ở dark mode
                        'gray-50': '#f9fafb',      // Header light bg
                        'gray-100': '#f3f4f6',     // Modal link hover light bg
                        'gray-200': '#e5e7eb',     // Chapter h3 border light
                        'gray-300': '#d1d5db',     // Modal link text dark
                        'gray-400': '#9ca3af',     // Footer text dark, button disabled text
                        'gray-500': '#6b7280',     // Footer text light, close modal text light
                        'gray-600': '#4b5563',     // Button disabled bg dark, scrollbar thumb dark
                        'gray-700': '#374151',     // Nav link hover dark bg, chapter h3 border dark
                        'gray-800': '#1f2937',     // Header dark bg, modal dark bg, story wrapper dark bg
                        'gray-900': '#111827',     // Body dark bg, scrollbar track dark
                        'red-400': '#f87171',      // Close modal hover dark
                        'red-600': '#dc2626',      // Close modal hover light
                        // Các màu neutral có thể được thay thế bằng gray tương ứng từ template mới
                        'neutral-800': '#1f2937', // Ví dụ: chapter dark bg
                        'neutral-900': '#111827', // Ví dụ: body text light
                        'white': '#ffffff',
                        'black': '#000000',
                         // Các màu cũ không còn dùng trực tiếp trong template này có thể lược bỏ nếu muốn
                    },
                    animation: {
                        'slide-up': 'slideUp 0.5s ease-out',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                    },
                },
            },
            darkMode: 'class',
             plugins: [
                // require('@tailwindcss/typography'), // Bỏ comment nếu cài đặt qua npm
            ],
        }
    </script>
    <style>
        /* Custom CSS for chapter transitions and other effects from new template */
        .chapter {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            opacity: 0;
            transform: translateY(15px);
            display: none;
        }
        .chapter.active {
            opacity: 1;
            transform: translateY(0);
            display: block;
        }

        html {
            scroll-behavior: smooth;
        }

        /* Modal styles from new template */
        #chapter-modal { /* ID này khớp với modal */
            transition: opacity 0.3s ease-in-out;
        }
        #chapter-modal .modal-content { /* Class này khớp với nội dung modal */
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #chapter-modal.modal-active { /* Class này được JS thêm để hiển thị modal */
            opacity: 1 !important; /* Quan trọng để ghi đè style inline nếu có */
            pointer-events: auto;
        }
        #chapter-modal.modal-active .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        /* Custom scrollbar for dark mode from new template */
        .dark body::-webkit-scrollbar { width: 10px; }
        .dark body::-webkit-scrollbar-track { background: #111827; /* gray-900 */ }
        .dark body::-webkit-scrollbar-thumb { background-color: #4b5563; /* gray-600 */ border-radius: 20px; border: 2px solid #111827; }
        .dark body::-webkit-scrollbar-thumb:hover { background-color: #6b7280; /* gray-500 */ }

        .dark #chapter-modal .modal-content ul::-webkit-scrollbar { width: 8px; }
        .dark #chapter-modal .modal-content ul::-webkit-scrollbar-track { background: #1f2937; /* gray-800 */ }
        .dark #chapter-modal .modal-content ul::-webkit-scrollbar-thumb { background: #4b5563; /* gray-600 */ border-radius: 4px; }
        .dark #chapter-modal .modal-content ul::-webkit-scrollbar-thumb:hover { background: #6b7280; /* gray-500 */ }

        /* Basic prose styling if @tailwindcss/typography is not used */
        .prose { max-width: none; }
        .prose p { margin-bottom: 1rem; line-height: 1.75; text-align: justify; } /* Thêm text-justify */
        .prose strong { font-weight: 600; }
        .prose h4 { font-size: 1.125rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: #374151; } /* Style cho h4 nếu có */
        .dark .dark\:prose-invert p { color: #d1d5db; }
        .dark .dark\:prose-invert strong { color: #ffffff; }
        .dark .dark\:prose-invert h4 { color: #d1d5db; }

        /* Chapter title styling from new template */
        .chapter > h3 { /* Áp dụng cho h3 trực tiếp trong .chapter */
             font-size: 1.875rem; font-weight: 600; margin-bottom: 1.5rem; margin-top: 1rem; color: #1f2937; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem;
        }
         /* General h1, h2 styling (main novel title) */
        main > h1 { font-size: 2.25rem; font-weight: 700; text-align: center; margin-bottom: 0.5rem; color: #111827; animation: slide-up 0.5s ease-out; }
        main > h2 { font-size: 1.875rem; font-weight: 600; text-align: center; margin-bottom: 2.5rem; color: #3b82f6; animation: slide-up 0.5s ease-out; }
        <div class="modal-content bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-lg shadow-2xl w-full max-w-md relative transform transition-all duration-300 ease-in-out scale-95 opacity-0">
            <span id="close-modal-btn" class="close absolute top-3 right-4 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400 text-3xl cursor-pointer transition-colors leading-none">&times;</span>
            <h3 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-white">Danh Sách Các Chương</h3>
            <ul id="modal-chapter-list" class="space-y-1 max-h-80 sm:max-h-96 overflow-y-auto pr-2">
                <li><a href="#chapter-1" data-chapter-id="chapter-1" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 1: Bản Hòa Âm Vĩnh Cửu</a></li>
                <li><a href="#chapter-2" data-chapter-id="chapter-2" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 2: Lời Phán Từ Trời</a></li>
                <li><a href="#chapter-3" data-chapter-id="chapter-3" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 3: Những Tia Lửa Nổi Loạn</a></li>
                <li><a href="#chapter-4" data-chapter-id="chapter-4" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 4: Những Tạo Vật Đầu Tiên</a></li>
                <li><a href="#chapter-5" data-chapter-id="chapter-5" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 5: Ánh Sáng Và Bóng Tối</a></li>
                <li><a href="#chapter-6" data-chapter-id="chapter-6" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 6: Lời Thì Thầm Của Con Rắn</a></li>
                <li><a href="#chapter-7" data-chapter-id="chapter-7" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 7: Sự Rạn Nứt</a></li>
                <li><a href="#chapter-8" data-chapter-id="chapter-8" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 8: Sự Ra Đời Của Eve</a></li>
                <li><a href="#chapter-9" data-chapter-id="chapter-9" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 9: Những Bóng Tối Thì Thầm</a></li>
                <li><a href="#chapter-10" data-chapter-id="chapter-10" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 10: Hạt Giống Của Sự Phá Hủy</a></li>
                <li><a href="#chapter-11" data-chapter-id="chapter-11" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 11: Sự Sa Ngã</a></li>
                <li><a href="#chapter-12" data-chapter-id="chapter-12" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 12: Sự Ra Đời Đầu Tiên</a></li>
                <li><a href="#chapter-13" data-chapter-id="chapter-13" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 13: Vết Nứt Đầu Tiên</a></li>
                <li><a href="#chapter-14" data-chapter-id="chapter-14" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 14: Dấu Ấn Của Cain</a></li>
                <li><a href="#chapter-15" data-chapter-id="chapter-15" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 15: Di Sản Của Cain</a></li>
                <li><a href="#chapter-16" data-chapter-id="chapter-16" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 16: Sự Phán Xét Đầu Tiên</a></li>
                <li><a href="#chapter-17" data-chapter-id="chapter-17" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 17: Cửa Lũ Mở Toang</a></li>
                <li><a href="#chapter-18" data-chapter-id="chapter-18" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 18: Cuộc Chiến Ánh Sáng Vĩnh Cửu</a></li>
                <li><a href="#chapter-19" data-chapter-id="chapter-19" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 19: Những Hạt Giống Của Sự Nổi Loạn</a></li>
                <li><a href="#chapter-20" data-chapter-id="chapter-20" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 20: Dư Âm của Những Lựa Chọn</a></li>
                <li><a href="#chapter-21" data-chapter-id="chapter-21" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 21: Sự Vỡ Nát của Tấm Màn</a></li>
                <li><a href="#chapter-22" data-chapter-id="chapter-22" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 22: Bên Kia Tấm Màn</a></li>
                <li><a href="#chapter-23" data-chapter-id="chapter-23" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 23: Sự Thật Bên Kia Tấm Màn</a></li>
                <li><a href="#chapter-24" data-chapter-id="chapter-24" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 24: Cái Giá của Ánh Sáng</a></li>
                <li><a href="#chapter-25" data-chapter-id="chapter-25" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 25: Phán Quyết và Sự Chia Cắt Vĩnh Viễn</a></li>
                <li><a href="#chapter-26" data-chapter-id="chapter-26" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 26: Bình Minh Cuối Cùng</a></li>
                <li><a href="#chapter-27" data-chapter-id="chapter-27" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 27: Ranh Giới Vĩnh Hằng</a></li>
                <li><a href="#chapter-28" data-chapter-id="chapter-28" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Chương 28: Ngã Tư Đường Vĩnh Cửu</a></li>
                <li><a href="#epilogue" data-chapter-id="epilogue" class="modal-chapter-link block p-3 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">Khúc Vĩ Thanh: Mưa Sao Băng Linh Hồn</a></li>
            </ul>
        </div>
    </div>

    <footer id="footer" class="bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 transition-colors duration-300 ease-in-out">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center">
            <div class="footer-links mb-6 space-x-2 sm:space-x-4">
                <a href="readnovel.html" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 text-sm sm:text-base transition-colors">Về Danh Sách</a>
                <a href="#navbar" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 text-sm sm:text-base transition-colors">Lên Đầu Trang</a>
                <a href="legnaxe_part1_en.html" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 text-sm sm:text-base transition-colors">English Version</a>
                <a href="author-about.html" class="text-gray-600 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 text-sm sm:text-base transition-colors">Về Tác Giả</a>
            </div>
            <p class="text-sm text-gray-500 dark:text-gray-400">© <span id="current-year">2025</span> LEGNAXE. All rights reserved. Author: Nguyen Minh Triet</p>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-2">Một sản phẩm của IVS JSC. Website: <a href="https://ivs.id.vn" target="_blank" rel="noopener noreferrer" class="hover:underline">ivs.id.vn</a></p>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Sử dụng Array.from để đảm bảo chapters là một mảng thực sự
        const chapters = Array.from(document.querySelectorAll('.chapter'));
        let currentChapterIndex = 0;

        // Lấy các nút điều khiển từ DOM, sử dụng ID từ template mới
        const prevButton = document.getElementById('prev-chapter-btn');
        const nextButton = document.getElementById('next-chapter-btn');
        const listChapterButton = document.getElementById('list-chapter-btn'); // ID nút mở modal

        const chapterModal = document.getElementById('chapter-modal');
        const closeModalButton = document.getElementById('close-modal-btn'); // ID nút đóng modal
        // Sử dụng class chung cho các link chương trong modal
        const modalChapterLinks = document.querySelectorAll('.modal-chapter-link');

        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement; // Áp dụng class 'dark' cho thẻ <html>
        const bodyElement = document.body; // Để kiểm soát overflow khi modal mở
        const themeIcon = themeToggle ? themeToggle.querySelector('i') : null;
        const currentYearSpan = document.getElementById('current-year');

        function showChapter(index, isInitialLoad = false) {
            if (index < 0 || index >= chapters.length) {
                console.warn("Chỉ số chương không hợp lệ:", index);
                return;
            }

            chapters.forEach((chapter, i) => {
                chapter.classList.toggle('active', i === index);
            });

            if (prevButton) prevButton.disabled = index === 0;
            if (nextButton) nextButton.disabled = index === chapters.length - 1;

            currentChapterIndex = index;

            if (!isInitialLoad) {
                const storyContentWrapper = document.querySelector('.story-content-wrapper');
                if (storyContentWrapper) {
                    const navbarHeight = document.getElementById('navbar')?.offsetHeight || 0;
                    // Cuộn đến đầu của .story-content-wrapper, trừ đi chiều cao navbar và một chút offset
                    window.scrollTo({
                        top: storyContentWrapper.offsetTop - navbarHeight - 20,
                        behavior: 'smooth'
                    });
                } else {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }

            // Cập nhật hash trên URL, chỉ khi không phải tải lần đầu để tránh nhảy trang không cần thiết
            if (chapters[currentChapterIndex] && !isInitialLoad) {
                window.location.hash = chapters[currentChapterIndex].id;
            }
        }
        
        function showChapterFromHash(isInitialLoad = false) {
            const hash = window.location.hash.substring(1); // Bỏ dấu '#'
            if (hash) {
                const targetIndex = chapters.findIndex(chap => chap.id === hash);
                if (targetIndex !== -1) {
                    showChapter(targetIndex, isInitialLoad);
                    // Nếu tải lần đầu và có hash, cuộn tới chương đó sau khi hiển thị
                    if (isInitialLoad) {
                        setTimeout(() => { // Đảm bảo chapter đã active và DOM cập nhật
                             const targetElement = document.getElementById(hash);
                             if(targetElement) {
                                const navbarHeight = document.getElementById('navbar')?.offsetHeight || 0;
                                window.scrollTo({
                                    top: targetElement.offsetTop - navbarHeight - 20, // Điều chỉnh offset nếu cần
                                    behavior: 'auto' // 'auto' cho lần tải đầu để không bị hiệu ứng cuộn chồng chéo
                                });
                             }
                        }, 100); // Delay nhỏ
                    }
                    return true; 
                }
            }
            return false; 
        }

        // Gán sự kiện cho các nút chuyển chương
        if (prevButton) {
            prevButton.addEventListener('click', () => {
                if (currentChapterIndex > 0) {
                    showChapter(currentChapterIndex - 1);
                }
            });
        }

        if (nextButton) {
            nextButton.addEventListener('click', () => {
                if (currentChapterIndex < chapters.length - 1) {
                    showChapter(currentChapterIndex + 1);
                }
            });
        }

        // Logic cho Modal danh sách chương
        if (listChapterButton && chapterModal) {
            listChapterButton.addEventListener('click', () => {
                chapterModal.style.display = 'flex';
                setTimeout(() => { 
                    chapterModal.classList.add('modal-active');
                }, 10); 
                bodyElement.style.overflow = 'hidden'; // Ngăn cuộn nền
            });
        }

        function closeModal() {
            if (chapterModal) {
                chapterModal.classList.remove('modal-active');
                setTimeout(() => {
                    if (!chapterModal.classList.contains('modal-active')) {
                         chapterModal.style.display = 'none';
                    }
                }, 300); // Khớp với thời gian transition CSS
                 bodyElement.style.overflow = ''; // Khôi phục cuộn nền
            }
        }

        if (closeModalButton) {
            closeModalButton.addEventListener('click', closeModal);
        }

        if (chapterModal) { // Đóng modal khi click vào vùng nền (backdrop)
            chapterModal.addEventListener('click', (event) => {
                if (event.target === chapterModal) {
                    closeModal();
                }
            });
        }

        modalChapterLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                // Lấy ID chương từ href hoặc data-attribute
                const chapterId = link.getAttribute('href')?.substring(1) || link.dataset.chapterId;
                if (!chapterId) return;

                const targetIndex = chapters.findIndex(chap => chap.id === chapterId);
                if (targetIndex !== -1) {
                    showChapter(targetIndex);
                }
                closeModal();
            });
        });

        // Logic chuyển đổi Theme (Sáng/Tối)
        function applyTheme(isDark) {
            htmlElement.classList.toggle('dark', isDark);
            if (themeIcon) {
                themeIcon.classList.toggle('fa-moon', !isDark);
                themeIcon.classList.toggle('fa-sun', isDark);
            }
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');
        let currentIsDarkMode = savedTheme === 'dark' || (savedTheme === null && prefersDarkScheme);
        
        applyTheme(currentIsDarkMode); // Áp dụng theme ban đầu

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                currentIsDarkMode = !htmlElement.classList.contains('dark');
                applyTheme(currentIsDarkMode);
            });
        }

        // Tải chương ban đầu (ưu tiên hash, sau đó là chương đầu tiên)
        if (chapters.length > 0) {
            if (!showChapterFromHash(true)) { 
                showChapter(0, true); 
            }
        } else { // Không có chương nào
            if (prevButton) prevButton.disabled = true;
            if (nextButton) nextButton.disabled = true;
            if (listChapterButton) listChapterButton.disabled = true;
        }
        
        // Cập nhật năm ở footer
        if (currentYearSpan) {
            currentYearSpan.textContent = new Date().getFullYear();
        }

        // Xử lý thay đổi hash (ví dụ: nút back/forward của trình duyệt)
        window.addEventListener('hashchange', () => showChapterFromHash(false));

    });
    </script>
</body>
</html>