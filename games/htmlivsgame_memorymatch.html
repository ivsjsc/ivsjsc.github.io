<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVS Memory Match - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f7ff; /* Fallback color */
            background-image: url('/images/games/ivsplaycard.png'); /* Thay thế URL này bằng hình ảnh của bạn */
            background-size: cover; /* Đảm bảo hình nền che phủ toàn bộ trang */
            background-position: center; /* Căn giữa hình nền */
            background-repeat: no-repeat; /* Không lặp lại hình nền */
            background-attachment: fixed; /* Giữ hình nền cố định khi cuộn trang */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow-y: auto;
        }
        .ivs-blue { background-color: #003366; }
        .ivs-blue-text { color: #003366; }
        .ivs-gold { background-color: #FFD700; }
        .ivs-gold-text { color: #B8860B; }

        .main-container {
            background-color: rgba(255, 255, 255, 0.9); /* Thêm độ trong suốt nhẹ để hình nền có thể nhìn thấy qua */
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
            padding: 25px;
            width: 100%;
            max-width: 680px;
            margin-bottom: 25px;
        }
        .ivs-logo {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.7rem;
            line-height: 2.2rem;
        }
        .game-board {
            display: grid;
            gap: 12px;
            margin: 25px auto;
            width: 100%;
        }
        .game-card {
            aspect-ratio: 1 / 1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.3s ease;
            transform-style: preserve-3d;
            position: relative;
            perspective: 1500px;
            word-break: break-word;
            hyphens: auto;
            box-shadow: 0 5px 10px rgba(0,0,0,0.12);
        }
        .game-card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.18);
            transform: translateY(-3px) scale(1.02);
        }
        .game-card .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }
        .game-card .card-front {
            background-image: url('https://placehold.co/100x100/003366/FFFFFF?text=IVS');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        .game-card .card-back {
            background: linear-gradient(135deg, #FFD700 0%, #ffec80 100%);
            color: #003366;
            transform: rotateY(180deg);
            font-weight: 600;
            font-size: 1.4rem;
            line-height: 1.3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 480px) {
            .game-card .card-back {
                font-size: 1.1rem;
                padding: 6px;
            }
        }
         @media (max-width: 360px) {
            .game-card .card-back {
                font-size: 0.9rem;
            }
        }

        .game-card.is-flipped {
            transform: rotateY(180deg);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        .game-card.is-matched {
            background-color: #28a745;
            cursor: default;
            opacity: 0.5;
            box-shadow: none;
        }
        .game-card.is-matched .card-front, .game-card.is-matched .card-back {
            background: #28a745 !important;
            color: white;
        }
        .game-info, .difficulty-selector, .scoreboard-container {
            margin-bottom: 20px;
            font-size: 1rem;
        }
        .game-info span, .difficulty-selector span, .scoreboard-container span {
            font-weight: 500;
            color: #003366;
        }
        .game-info .timer {
            color: #c0392b;
            font-weight: 700;
        }
        .btn-action, .btn-difficulty, .btn-language {
            background-color: #FFD700;
            color: #003366;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: background-color 0.25s ease, transform 0.15s ease, box-shadow 0.25s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-action:hover, .btn-difficulty:hover, .btn-language:hover {
            background-color: #f1c40f;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
        }
        .btn-difficulty.active {
            background-color: #003366;
            color: #FFD700;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.2);
        }
        .message-overlay, .name-input-overlay, .pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .message-content, .name-input-content, .pause-content {
            background-color: white;
            padding: 30px 35px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            color: #003366;
            max-width: 90%;
            width: 420px;
        }
        .message-content h2, .name-input-content h2, .pause-content h2 {
            font-size: 1.8rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .message-content p, .name-input-content p, .pause-content p {
            font-size: 1.05rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .name-input-content input[type="text"] {
            width: calc(100% - 24px);
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            font-size: 1rem;
        }
        .hidden {
            display: none !important;
        }
        .scoreboard-container {
             background-color: rgba(248, 249, 250, 0.9); /* Thêm độ trong suốt nhẹ */
            padding: 20px;
            border-radius: 12px;
        }
        .scoreboard-container h3 {
            font-family: 'Montserrat', sans-serif;
            color: #003366;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.4rem;
            font-weight: 600;
        }
        .scoreboard-list {
            list-style: none;
            padding: 0;
        }
        .scoreboard-list li {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-bottom: 1px solid #e0e6ed;
            font-size: 0.95rem;
        }
        .scoreboard-list li:last-child {
            border-bottom: none;
        }
        .scoreboard-list .rank { width: 15%; text-align: left; font-weight: 600; }
        .scoreboard-list .name { width: 55%; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .scoreboard-list .score { width: 30%; text-align: right; font-weight: 700; }

        .controls-area {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
        }
        .language-switcher {
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <header class="ivs-blue text-white p-4 rounded-t-lg mb-4 text-center">
            <h1 class="ivs-logo" data-translate="headerTitle">IVS Memory Match: Eng-Vie</h1>
        </header>

        <div class="difficulty-selector mb-4 text-center">
            <h3 class="text-lg font-semibold ivs-blue-text mb-2" data-translate="selectDifficulty">Select Difficulty:</h3>
            <div class="flex justify-center gap-2">
                <button id="difficulty-easy" class="btn-difficulty" data-difficulty="easy" data-translate="easy">Easy</button>
                <button id="difficulty-medium" class="btn-difficulty active" data-difficulty="medium" data-translate="medium">Medium</button>
                <button id="difficulty-hard" class="btn-difficulty" data-difficulty="hard" data-translate="hard">Hard</button>
            </div>
        </div>

        <div class="game-info grid grid-cols-2 sm:grid-cols-4 gap-2 items-center p-3 bg-gray-100 rounded-lg text-center sm:text-left">
            <div><span data-translate="level">Level</span>: <span id="level-display">1</span></div>
            <div class="sm:text-center"><i class="fas fa-stopwatch mr-1"></i><span data-translate="time">Time</span>: <span id="time-display" class="timer">00:00</span></div>
            <div class="sm:text-center"><span data-translate="flips">Flips</span>: <span id="flips-count">0</span></div>
            <div class="sm:text-right"><span data-translate="totalScore">Total Score</span>: <span id="total-score-display">0</span></div>
        </div>


        <div id="game-board" class="game-board">
        </div>

        <div class="controls-area text-center">
            <button id="pause-resume-button" class="btn-action"><i class="fas fa-pause mr-1"></i><span data-translate="pause">Pause</span></button>
            <button id="reset-level-button" class="btn-action"><i class="fas fa-redo mr-1"></i><span data-translate="restartLevel">Restart Level</span></button>
            <button id="language-switcher-button" class="btn-language ml-2">VI/EN</button>
        </div>

        <footer class="text-center p-3 mt-4 bg-gray-50 rounded-b-lg">
            <p class="text-xs text-gray-400" data-translate="copyright"> <i class="fa-solid fa-copyright"></i> 2025 IVS JSC. All rights reserved.</p>
        </footer>
    </div>

    <div class="scoreboard-container main-container">
        <h3><i class="fas fa-trophy ivs-gold-text"></i> <span data-translate="top5Scoreboard">Top 5 Scoreboard</span> <i class="fas fa-trophy ivs-gold-text"></i></h3>
        <ol id="scoreboard-list" class="scoreboard-list">
        </ol>
    </div>

    <div id="message-overlay" class="message-overlay hidden">
        <div class="message-content">
            <h2 id="message-title" data-translate-dynamic="messageTitle">Congratulations!</h2>
            <p id="message-text" data-translate-dynamic="messageText">You've completed the level!</p>
            <p><span data-translate="levelScore">Level Score</span>: <span id="level-score-message">0</span></p>
            <p><span data-translate="totalFlips">Total Flips</span>: <span id="final-flips">0</span></p>
            <p><span data-translate="timeBonus">Time Bonus</span>: <span id="time-bonus-message">0</span></p>
            <button id="next-action-button" class="btn-action" data-translate-dynamic="nextAction">Next Level</button>
        </div>
    </div>

    <div id="name-input-overlay" class="name-input-overlay hidden">
        <div class="name-input-content">
            <h2 data-translate="highScoreTitle"><i class="fas fa-medal ivs-gold-text"></i> High Score! <i class="fas fa-medal ivs-gold-text"></i></h2>
            <p data-translate="highScorePrompt">You've made it to the Top 5! Please enter your name (1-10 characters):</p>
            <input type="text" id="player-name-input" maxlength="10" data-translate-placeholder="enterNamePlaceholder" placeholder="Enter name">
            <button id="submit-name-button" class="btn-action" data-translate="saveScore">Save Score</button>
        </div>
    </div>

    <div id="pause-overlay" class="pause-overlay hidden">
        <div class="pause-content">
            <h2 data-translate="gamePausedTitle"><i class="fas fa-pause-circle ivs-blue-text"></i> Game Paused</h2>
            <p data-translate="gamePausedText">Take a moment. Press Resume to continue.</p>
            <button id="resume-game-button-modal" class="btn-action"><i class="fas fa-play mr-1"></i><span data-translate="resume">Resume</span></button>
        </div>
    </div>


    <script>
        const translations = {
            en: {
                pageTitle: "IVS Memory Match - Enhanced",
                headerTitle: "IVS Memory Match: Eng-Vie",
                selectDifficulty: "Select Difficulty:",
                easy: "Easy",
                medium: "Medium",
                hard: "Hard",
                level: "Level",
                time: "Time",
                flips: "Flips",
                totalScore: "Total Score",
                pause: "Pause",
                resume: "Resume",
                restartLevel: "Restart Level",
                copyright: '<i class="fa-solid fa-copyright"></i> 2025 IVS JSC. All rights reserved.',
                top5Scoreboard: "Top 5 Scoreboard",
                levelScore: "Level Score",
                totalFlips: "Total Flips",
                timeBonus: "Time Bonus",
                messageTitleCongrats: "Congratulations!",
                messageTextLevelComplete: "You've completed the level!",
                messageTitleExcellent: "Excellent!",
                messageTextNextChallenge: "You've completed Level {level}! Ready for the next challenge?",
                messageTitleAwesome: "Awesome!",
                messageTextAllLevelsComplete: "You've completed all levels!",
                messageTitleTimesUp: "Time's Up!",
                messageTextTimesUpLevel: "You ran out of time for Level {level}.",
                levelScoreTimeOut: "0 (Time Out)",
                nextActionNextLevel: "Next Level",
                nextActionRestartLevel: "Restart Level",
                nextActionPlayAgain: "Play Again From Start",
                highScoreTitle: "<i class=\"fas fa-medal ivs-gold-text\"></i> High Score! <i class=\"fas fa-medal ivs-gold-text\"></i>",
                highScorePrompt: "You've made it to the Top 5! Please enter your name (1-10 characters):",
                enterNamePlaceholder: "Enter name",
                saveScore: "Save Score",
                gamePausedTitle: "<i class=\"fas fa-pause-circle ivs-blue-text\"></i> Game Paused",
                gamePausedText: "Take a moment. Press Resume to continue.",
                noHighScores: "No high scores yet.",
                alertNameLength: "Name must be between 1 and 10 characters."
            },
            vi: {
                pageTitle: "IVS Memory Match - Nâng cao",
                headerTitle: "IVS Memory Match: Anh-Việt",
                selectDifficulty: "Chọn Độ Khó:",
                easy: "Dễ",
                medium: "Trung Bình",
                hard: "Khó",
                level: "Màn",
                time: "Thời Gian",
                flips: "Lật",
                totalScore: "Tổng Điểm",
                pause: "Tạm Dừng",
                resume: "Tiếp Tục",
                restartLevel: "Chơi Lại Màn",
                copyright: '<i class="fa-solid fa-copyright"></i> 2025 IVS JSC. Mọi quyền được bảo lưu.',
                top5Scoreboard: "Top 5 Bảng Điểm",
                levelScore: "Điểm Màn",
                totalFlips: "Tổng Lượt Lật",
                timeBonus: "Thưởng Thời Gian",
                messageTitleCongrats: "Chúc Mừng!",
                messageTextLevelComplete: "Bạn đã hoàn thành màn chơi!",
                messageTitleExcellent: "Tuyệt Vời!",
                messageTextNextChallenge: "Bạn đã hoàn thành Màn {level}! Sẵn sàng cho thử thách tiếp theo?",
                messageTitleAwesome: "Xuất Sắc!",
                messageTextAllLevelsComplete: "Bạn đã hoàn thành tất cả các màn!",
                messageTitleTimesUp: "Hết Giờ!",
                messageTextTimesUpLevel: "Bạn đã hết thời gian cho Màn {level}.",
                levelScoreTimeOut: "0 (Hết Giờ)",
                nextActionNextLevel: "Màn Tiếp Theo",
                nextActionRestartLevel: "Chơi Lại Màn",
                nextActionPlayAgain: "Chơi Lại Từ Đầu",
                highScoreTitle: "<i class=\"fas fa-medal ivs-gold-text\"></i> Điểm Cao! <i class=\"fas fa-medal ivs-gold-text\"></i>",
                highScorePrompt: "Bạn đã lọt vào Top 5! Vui lòng nhập tên của bạn (1-10 ký tự):",
                enterNamePlaceholder: "Nhập tên",
                saveScore: "Lưu Điểm",
                gamePausedTitle: "<i class=\"fas fa-pause-circle ivs-blue-text\"></i> Game Tạm Dừng",
                gamePausedText: "Hãy nghỉ ngơi một chút. Nhấn Tiếp Tục để chơi tiếp.",
                noHighScores: "Chưa có điểm cao nào.",
                alertNameLength: "Tên phải từ 1 đến 10 ký tự."
            }
        };

        let currentLanguage = localStorage.getItem('ivsMemoryMatchLanguage_v1') || 'en';

        function applyTranslations(lang) {
            document.documentElement.lang = lang;
            document.title = translations[lang].pageTitle;
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                if (translations[lang][key]) {
                    if (el.tagName === 'INPUT' && el.dataset.translatePlaceholder) {
                        el.placeholder = translations[lang][key];
                    } else if (key === 'highScoreTitle' || key === 'gamePausedTitle' || key === 'copyright') {
                        el.innerHTML = translations[lang][key];
                    } else {
                        const icon = el.querySelector('i.fas, i.fa-solid');
                        if (icon && el.firstChild === icon && (el.childNodes.length === 1 || (el.childNodes.length > 1 && el.childNodes[1].nodeType === Node.TEXT_NODE))) {
                             let textContent = " " + translations[lang][key];
                             while(icon.nextSibling && icon.nextSibling.nodeType === Node.TEXT_NODE) {
                                 el.removeChild(icon.nextSibling);
                             }
                             if(icon.nextSibling) {
                                el.insertBefore(document.createTextNode(textContent), icon.nextSibling);
                             } else {
                                el.appendChild(document.createTextNode(textContent));
                             }
                        } else {
                            el.textContent = translations[lang][key];
                        }
                    }
                }
            });

            const pauseResumeSpan = pauseResumeButton.querySelector('span');
            if (pauseResumeSpan) {
                const iconHTML = pauseResumeButton.querySelector('i')?.outerHTML || "";
                pauseResumeSpan.textContent = gamePaused ? translations[lang].resume : translations[lang].pause;
                if (iconHTML) pauseResumeButton.innerHTML = iconHTML + " " + pauseResumeSpan.outerHTML;

            }
            const resumeModalButtonSpan = resumeGameButtonModal.querySelector('span');
             if (resumeModalButtonSpan) {
                const iconHTMLModal = resumeGameButtonModal.querySelector('i')?.outerHTML || "";
                resumeModalButtonSpan.textContent = translations[lang].resume;
                 if (iconHTMLModal) resumeGameButtonModal.innerHTML = iconHTMLModal + " " + resumeModalButtonSpan.outerHTML;
            }
        }


        const gameBoard = document.getElementById('game-board');
        const flipsCountDisplay = document.getElementById('flips-count');
        const levelDisplay = document.getElementById('level-display');
        const totalScoreDisplay = document.getElementById('total-score-display');
        const timeDisplay = document.getElementById('time-display');
        const resetLevelButton = document.getElementById('reset-level-button');
        const pauseResumeButton = document.getElementById('pause-resume-button');
        const languageSwitcherButton = document.getElementById('language-switcher-button');

        const messageOverlay = document.getElementById('message-overlay');
        const messageTitleEl = document.getElementById('message-title');
        const messageTextEl = document.getElementById('message-text');
        const finalFlipsDisplay = document.getElementById('final-flips');
        const levelScoreMessageDisplay = document.getElementById('level-score-message');
        const timeBonusMessageDisplay = document.getElementById('time-bonus-message');
        const nextActionButton = document.getElementById('next-action-button');

        const nameInputOverlay = document.getElementById('name-input-overlay');
        const playerNameInput = document.getElementById('player-name-input');
        const submitNameButton = document.getElementById('submit-name-button');
        const scoreboardList = document.getElementById('scoreboard-list');

        const difficultyButtons = [
            document.getElementById('difficulty-easy'),
            document.getElementById('difficulty-medium'),
            document.getElementById('difficulty-hard')
        ];

        const pauseOverlay = document.getElementById('pause-overlay');
        const resumeGameButtonModal = document.getElementById('resume-game-button-modal');

        const allLevelsData = [
            {
                level: 1,
                pairs: [ {en: "Hello", vi: "Xin chào"}, {en: "Cat", vi: "Con mèo"}, {en: "Dog", vi: "Con chó"} ],
                columns: 3, basePointsPerMatch: 50, efficiencyBonusBase: 50, timeLimitMedium: 45
            },
            {
                level: 2,
                pairs: [ {en: "Goodbye", vi: "Tạm biệt"}, {en: "Thank you", vi: "Cảm ơn"}, {en: "Yes", vi: "Có"}, {en: "No", vi: "Không"} ],
                columns: 4, basePointsPerMatch: 60, efficiencyBonusBase: 80, timeLimitMedium: 70
            },
            {
                level: 3,
                pairs: [ {en: "Good morning", vi: "Chào buổi sáng"}, {en: "How are you?", vi: "Bạn khỏe không?"}, {en: "I am fine", vi: "Tôi khỏe"}, {en: "What is this?", vi: "Đây là cái gì?"}, {en: "Red", vi: "Màu đỏ"}, {en: "Blue", vi: "Màu xanh dương"} ],
                columns: 4, basePointsPerMatch: 70, efficiencyBonusBase: 120, timeLimitMedium: 100
            },
            {
                level: 4,
                pairs: [
                    {en: "Water", vi: "Nước"}, {en: "Fire", vi: "Lửa"}, {en: "Earth", vi: "Đất"}, {en: "Air", vi: "Không khí"},
                    {en: "Sun", vi: "Mặt trời"}, {en: "Moon", vi: "Mặt trăng"}, {en: "Star", vi: "Ngôi sao"}, {en: "Tree", vi: "Cây"}
                ],
                columns: 4, basePointsPerMatch: 75, efficiencyBonusBase: 150, timeLimitMedium: 120
            },
            {
                level: 5,
                pairs: [
                    {en: "Computer", vi: "Máy tính"}, {en: "Keyboard", vi: "Bàn phím"}, {en: "Mouse", vi: "Chuột (máy tính)"},
                    {en: "Screen", vi: "Màn hình"}, {en: "Software", vi: "Phần mềm"}, {en: "Hardware", vi: "Phần cứng"},
                    {en: "Internet", vi: "Mạng Internet"}, {en: "Website", vi: "Trang web"}, {en: "Programming", vi: "Lập trình"},
                    {en: "Developer", vi: "Lập trình viên"}
                ],
                columns: 5, basePointsPerMatch: 80, efficiencyBonusBase: 200, timeLimitMedium: 150
            },
            {
                level: 6,
                pairs: [
                    {en: "Run", vi: "Chạy"}, {en: "Eat", vi: "Ăn"}, {en: "Drink", vi: "Uống"}, {en: "Sleep", vi: "Ngủ"},
                    {en: "Read", vi: "Đọc"}, {en: "Write", vi: "Viết"}, {en: "Speak", vi: "Nói"}, {en: "Listen", vi: "Nghe"},
                    {en: "Walk", vi: "Đi bộ"}, {en: "Swim", vi: "Bơi"}
                ],
                columns: 5,
                basePointsPerMatch: 85,
                efficiencyBonusBase: 220,
                timeLimitMedium: 160
            },
            {
                level: 7,
                pairs: [
                    {en: "Happy", vi: "Vui vẻ"}, {en: "Sad", vi: "Buồn"}, {en: "Big", vi: "To"}, {en: "Small", vi: "Nhỏ"},
                    {en: "Fast", vi: "Nhanh"}, {en: "Slow", vi: "Chậm"}, {en: "Good", vi: "Tốt"}, {en: "Bad", vi: "Tệ"},
                    {en: "Hot", vi: "Nóng"}, {en: "Cold", vi: "Lạnh"}, {en: "New", vi: "Mới"}, {en: "Old", vi: "Cũ"}
                ],
                columns: 6,
                basePointsPerMatch: 90,
                efficiencyBonusBase: 250,
                timeLimitMedium: 180
            },
            {
                level: 8,
                pairs: [
                    {en: "Bread", vi: "Bánh mì"}, {en: "Rice", vi: "Cơm"}, {en: "Milk", vi: "Sữa"}, {en: "Juice", vi: "Nước ép"},
                    {en: "Apple", vi: "Táo"}, {en: "Banana", vi: "Chuối"}, {en: "Orange", vi: "Cam"}, {en: "Chicken", vi: "Gà"},
                    {en: "Fish", vi: "Cá"}, {en: "Beef", vi: "Thịt bò"}, {en: "Coffee", vi: "Cà phê"}, {en: "Tea", vi: "Trà"}
                ],
                columns: 6,
                basePointsPerMatch: 95,
                efficiencyBonusBase: 280,
                timeLimitMedium: 190
            },
            {
                level: 9,
                pairs: [
                    {en: "Lion", vi: "Sư tử"}, {en: "Tiger", vi: "Hổ"}, {en: "Elephant", vi: "Voi"}, {en: "Monkey", vi: "Khỉ"},
                    {en: "Bear", vi: "Gấu"}, {en: "Horse", vi: "Ngựa"}, {en: "Cow", vi: "Bò"}, {en: "Pig", vi: "Lợn"},
                    {en: "Sheep", vi: "Cừu"}, {en: "Bird", vi: "Chim"}, {en: "Snake", vi: "Rắn"}, {en: "Rabbit", vi: "Thỏ"},
                    {en: "Wolf", vi: "Sói"}, {en: "Fox", vi: "Cáo"}, {en: "Duck", vi: "Vịt"}
                ],
                columns: 5,
                basePointsPerMatch: 100,
                efficiencyBonusBase: 320,
                timeLimitMedium: 220
            },
            {
                level: 10,
                pairs: [
                    {en: "House", vi: "Nhà"}, {en: "Room", vi: "Phòng"}, {en: "Door", vi: "Cửa ra vào"}, {en: "Window", vi: "Cửa sổ"},
                    {en: "Table", vi: "Bàn"}, {en: "Chair", vi: "Ghế"}, {en: "Bed", vi: "Giường"}, {en: "Kitchen", vi: "Nhà bếp"},
                    {en: "Bathroom", vi: "Phòng tắm"}, {en: "Garden", vi: "Vườn"}, {en: "Sofa", vi: "Ghế sofa"}, {en: "Lamp", vi: "Đèn"},
                    {en: "Television", vi: "Ti vi"}, {en: "Book", vi: "Sách"}, {en: "Clock", vi: "Đồng hồ"}
                ],
                columns: 6,
                basePointsPerMatch: 105,
                efficiencyBonusBase: 350,
                timeLimitMedium: 230
            },
            {
                level: 11,
                pairs: [
                    {en: "Doctor", vi: "Bác sĩ"}, {en: "Teacher", vi: "Giáo viên"}, {en: "Engineer", vi: "Kỹ sư"}, {en: "Farmer", vi: "Nông dân"},
                    {en: "Singer", vi: "Ca sĩ"}, {en: "Artist", vi: "Họa sĩ"}, {en: "Chef", vi: "Đầu bếp"}, {en: "Police", vi: "Cảnh sát"},
                    {en: "Firefighter", vi: "Lính cứu hỏa"}, {en: "Pilot", vi: "Phi công"}, {en: "Driver", vi: "Tài xế"}, {en: "Writer", vi: "Nhà văn"},
                    {en: "Scientist", vi: "Nhà khoa học"}, {en: "Manager", vi: "Quản lý"}, {en: "Nurse", vi: "Y tá"}, {en: "Actor", vi: "Diễn viên"},
                    {en: "Student", vi: "Học sinh"}, {en: "Worker", vi: "Công nhân"}
                ],
                columns: 6,
                basePointsPerMatch: 110,
                efficiencyBonusBase: 400,
                timeLimitMedium: 260
            },
            {
                level: 12,
                pairs: [
                    {en: "Travel", vi: "Du lịch"}, {en: "Airport", vi: "Sân bay"}, {en: "Train", vi: "Tàu hỏa"}, {en: "Bus", vi: "Xe buýt"},
                    {en: "Car", vi: "Xe hơi"}, {en: "Hotel", vi: "Khách sạn"}, {en: "Passport", vi: "Hộ chiếu"}, {en: "Ticket", vi: "Vé"},
                    {en: "Map", vi: "Bản đồ"}, {en: "Beach", vi: "Bãi biển"}, {en: "Mountain", vi: "Núi"}, {en: "City", vi: "Thành phố"},
                    {en: "Country", vi: "Đất nước"}, {en: "Luggage", vi: "Hành lý"}, {en: "Vacation", vi: "Kỳ nghỉ"}, {en: "Camera", vi: "Máy ảnh"},
                    {en: "Guide", vi: "Hướng dẫn viên"}, {en: "Souvenir", vi: "Quà lưu niệm"}
                ],
                columns: 6,
                basePointsPerMatch: 115,
                efficiencyBonusBase: 430,
                timeLimitMedium: 270
            },
            {
                level: 13,
                pairs: [
                    {en: "Love", vi: "Yêu"}, {en: "Hate", vi: "Ghét"}, {en: "Angry", vi: "Tức giận"}, {en: "Scared", vi: "Sợ hãi"},
                    {en: "Surprised", vi: "Ngạc nhiên"}, {en: "Excited", vi: "Hào hứng"}, {en: "Bored", vi: "Chán nản"}, {en: "Tired", vi: "Mệt mỏi"},
                    {en: "Shy", vi: "Ngại ngùng"}, {en: "Proud", vi: "Tự hào"}, {en: "Worried", vi: "Lo lắng"}, {en: "Confused", vi: "Bối rối"},
                    {en: "Hopeful", vi: "Hy vọng"}, {en: "Jealous", vi: "Ghen tị"}, {en: "Calm", vi: "Bình tĩnh"}, {en: "Anxious", vi: "Lo âu"},
                    {en: "Grateful", vi: "Biết ơn"}, {en: "Lonely", vi: "Cô đơn"}, {en: "Curious", vi: "Tò mò"}, {en: "Relieved", vi: "Nhẹ nhõm"},
                    {en: "Embarrassed", vi: "Xấu hổ"}
                ],
                columns: 6,
                basePointsPerMatch: 120,
                efficiencyBonusBase: 480,
                timeLimitMedium: 300
            },
            {
                level: 14,
                pairs: [
                    {en: "Forest", vi: "Rừng"}, {en: "River", vi: "Sông"}, {en: "Ocean", vi: "Đại dương"}, {en: "Desert", vi: "Sa mạc"},
                    {en: "Volcano", vi: "Núi lửa"}, {en: "Island", vi: "Đảo"}, {en: "Flower", vi: "Hoa"}, {en: "Grass", vi: "Cỏ"},
                    {en: "Sky", vi: "Bầu trời"}, {en: "Cloud", vi: "Mây"}, {en: "Rain", vi: "Mưa"}, {en: "Snow", vi: "Tuyết"},
                    {en: "Wind", vi: "Gió"}, {en: "Stone", vi: "Đá"}, {en: "Cave", vi: "Hang động"}, {en: "Valley", vi: "Thung lũng"},
                    {en: "Lake", vi: "Hồ"}, {en: "Environment", vi: "Môi trường"}, {en: "Pollution", vi: "Ô nhiễm"}, {en: "Recycle", vi: "Tái chế"},
                    {en: "Climate", vi: "Khí hậu"}
                ],
                columns: 6,
                basePointsPerMatch: 125,
                efficiencyBonusBase: 510,
                timeLimitMedium: 310
            },
            {
                level: 15,
                pairs: [
                    {en: "Idea", vi: "Ý tưởng"}, {en: "Dream", vi: "Giấc mơ"}, {en: "Memory", vi: "Ký ức"}, {en: "Thought", vi: "Suy nghĩ"},
                    {en: "Knowledge", vi: "Kiến thức"}, {en: "Wisdom", vi: "Trí tuệ"}, {en: "Truth", vi: "Sự thật"}, {en: "Lie", vi: "Lời nói dối"},
                    {en: "Freedom", vi: "Tự do"}, {en: "Justice", vi: "Công lý"}, {en: "Peace", vi: "Hòa bình"}, {en: "War", vi: "Chiến tranh"},
                    {en: "Success", vi: "Thành công"}, {en: "Failure", vi: "Thất bại"}, {en: "Problem", vi: "Vấn đề"}, {en: "Solution", vi: "Giải pháp"},
                    {en: "Beginning", vi: "Bắt đầu"}, {en: "End", vi: "Kết thúc"}, {en: "Change", vi: "Thay đổi"}, {en: "Improve", vi: "Cải thiện"},
                    {en: "Challenge", vi: "Thử thách"}, {en: "Opportunity", vi: "Cơ hội"}, {en: "Responsibility", vi: "Trách nhiệm"}, {en: "Effort", vi: "Nỗ lực"}
                ],
                columns: 6,
                basePointsPerMatch: 130,
                efficiencyBonusBase: 550,
                timeLimitMedium: 340
            },
            {
                level: 16,
                pairs: [
                    {en: "Circle", vi: "Hình tròn"}, {en: "Square", vi: "Hình vuông"}, {en: "Triangle", vi: "Hình tam giác"}, {en: "Rectangle", vi: "Hình chữ nhật"},
                    {en: "Star", vi: "Hình ngôi sao"}, {en: "Heart", vi: "Hình trái tim"}, {en: "Oval", vi: "Hình bầu dục"}, {en: "Diamond", vi: "Hình thoi"},
                    {en: "Cube", vi: "Hình lập phương"}, {en: "Sphere", vi: "Hình cầu"}, {en: "Cylinder", vi: "Hình trụ"}, {en: "Pyramid", vi: "Hình chóp"}
                ],
                columns: 6,
                basePointsPerMatch: 135,
                efficiencyBonusBase: 570,
                timeLimitMedium: 200
            },
            {
                level: 17,
                pairs: [
                    {en: "Turquoise", vi: "Màu ngọc lam"}, {en: "Magenta", vi: "Màu đỏ tươi"}, {en: "Violet", vi: "Màu tím"}, {en: "Indigo", vi: "Màu chàm"},
                    {en: "Beige", vi: "Màu be"}, {en: "Maroon", vi: "Màu hạt dẻ"}, {en: "Navy Blue", vi: "Xanh hải quân"}, {en: "Teal", vi: "Màu mòng két"},
                    {en: "Gold", vi: "Màu vàng kim"}, {en: "Silver", vi: "Màu bạc"}, {en: "Bronze", vi: "Màu đồng"}, {en: "Lavender", vi: "Màu hoa oải hương"}
                ],
                columns: 6,
                basePointsPerMatch: 140,
                efficiencyBonusBase: 590,
                timeLimitMedium: 210
            },
            {
                level: 18,
                pairs: [
                    {en: "Head", vi: "Đầu"}, {en: "Hair", vi: "Tóc"}, {en: "Eye", vi: "Mắt"}, {en: "Nose", vi: "Mũi"},
                    {en: "Mouth", vi: "Miệng"}, {en: "Ear", vi: "Tai"}, {en: "Neck", vi: "Cổ"}, {en: "Shoulder", vi: "Vai"},
                    {en: "Arm", vi: "Cánh tay"}, {en: "Hand", vi: "Bàn tay"}, {en: "Finger", vi: "Ngón tay"}, {en: "Leg", vi: "Chân"},
                    {en: "Foot", vi: "Bàn chân"}, {en: "Toe", vi: "Ngón chân"}, {en: "Back", vi: "Lưng"}, {en: "Chest", vi: "Ngực"},
                    {en: "Stomach", vi: "Bụng"}, {en: "Knee", vi: "Đầu gối"}
                ],
                columns: 6,
                basePointsPerMatch: 145,
                efficiencyBonusBase: 620,
                timeLimitMedium: 280
            },
            {
                level: 19,
                pairs: [
                    {en: "Shirt", vi: "Áo sơ mi"}, {en: "Pants", vi: "Quần dài"}, {en: "Dress", vi: "Váy liền"}, {en: "Skirt", vi: "Chân váy"},
                    {en: "Jacket", vi: "Áo khoác"}, {en: "Shoes", vi: "Giày"}, {en: "Socks", vi: "Tất"}, {en: "Hat", vi: "Mũ"},
                    {en: "Gloves", vi: "Găng tay"}, {en: "Scarf", vi: "Khăn quàng"}, {en: "Sweater", vi: "Áo len"}, {en: "Coat", vi: "Áo choàng"},
                    {en: "T-shirt", vi: "Áo phông"}, {en: "Shorts", vi: "Quần đùi"}, {en: "Boots", vi: "Ủng/Bốt"}, {en: "Sandals", vi: "Dép σαν đan"},
                    {en: "Belt", vi: "Thắt lưng"}, {en: "Tie", vi: "Cà vạt"}
                ],
                columns: 6,
                basePointsPerMatch: 150,
                efficiencyBonusBase: 650,
                timeLimitMedium: 290
            },
            {
                level: 20,
                pairs: [
                    {en: "Sunny", vi: "Nắng"}, {en: "Cloudy", vi: "Nhiều mây"}, {en: "Rainy", vi: "Mưa"}, {en: "Snowy", vi: "Tuyết rơi"},
                    {en: "Windy", vi: "Nhiều gió"}, {en: "Stormy", vi: "Bão"}, {en: "Foggy", vi: "Sương mù"}, {en: "Temperature", vi: "Nhiệt độ"},
                    {en: "Humidity", vi: "Độ ẩm"}, {en: "Forecast", vi: "Dự báo"}, {en: "Rainbow", vi: "Cầu vồng"}, {en: "Thunder", vi: "Sấm"},
                    {en: "Lightning", vi: "Chớp"}, {en: "Drought", vi: "Hạn hán"}, {en: "Flood", vi: "Lũ lụt"}, {en: "Breeze", vi: "Gió nhẹ"}
                ],
                columns: 6,
                basePointsPerMatch: 155,
                efficiencyBonusBase: 680,
                timeLimitMedium: 250
            },
            {
                level: 21,
                pairs: [
                    {en: "Football", vi: "Bóng đá"}, {en: "Basketball", vi: "Bóng rổ"}, {en: "Tennis", vi: "Quần vợt"}, {en: "Swimming", vi: "Bơi lội"},
                    {en: "Cycling", vi: "Đạp xe"}, {en: "Running", vi: "Chạy bộ"}, {en: "Volleyball", vi: "Bóng chuyền"}, {en: "Badminton", vi: "Cầu lông"},
                    {en: "Golf", vi: "Đánh gôn"}, {en: "Skiing", vi: "Trượt tuyết"}, {en: "Baseball", vi: "Bóng chày"}, {en: "Boxing", vi: "Quyền Anh"},
                    {en: "Yoga", vi: "Yoga"}, {en: "Gymnastics", vi: "Thể dục dụng cụ"}, {en: "Hockey", vi: "Khúc côn cầu"}, {en: "Archery", vi: "Bắn cung"},
                    {en: "Fishing", vi: "Câu cá"}, {en: "Hiking", vi: "Đi bộ đường dài"}, {en: "Surfing", vi: "Lướt sóng"}, {en: "Skateboarding", vi: "Trượt ván"}
                ],
                columns: 5,
                basePointsPerMatch: 160,
                efficiencyBonusBase: 720,
                timeLimitMedium: 320
            },
            {
                level: 22,
                pairs: [
                    {en: "Music", vi: "Âm nhạc"}, {en: "Song", vi: "Bài hát"}, {en: "Melody", vi: "Giai điệu"}, {en: "Rhythm", vi: "Nhịp điệu"},
                    {en: "Guitar", vi: "Đàn ghi-ta"}, {en: "Piano", vi: "Đàn piano"}, {en: "Violin", vi: "Đàn vi-ô-lông"}, {en: "Drums", vi: "Trống"},
                    {en: "Flute", vi: "Sáo"}, {en: "Trumpet", vi: "Kèn trumpet"}, {en: "Singer", vi: "Ca sĩ"}, {en: "Band", vi: "Ban nhạc"},
                    {en: "Concert", vi: "Buổi hòa nhạc"}, {en: "Album", vi: "Album"}, {en: "Genre", vi: "Thể loại"}, {en: "Lyrics", vi: "Lời bài hát"},
                    {en: "Note", vi: "Nốt nhạc"}, {en: "Orchestra", vi: "Dàn nhạc giao hưởng"}, {en: "Keyboard (Music)", vi: "Đàn organ"}, {en: "Saxophone", vi: "Kèn saxophone"}
                ],
                columns: 5,
                basePointsPerMatch: 165,
                efficiencyBonusBase: 750,
                timeLimitMedium: 330
            },
            {
                level: 23,
                pairs: [
                    {en: "Subway", vi: "Tàu điện ngầm"}, {en: "Motorcycle", vi: "Xe máy"}, {en: "Scooter", vi: "Xe tay ga"}, {en: "Helicopter", vi: "Trực thăng"},
                    {en: "Spaceship", vi: "Tàu vũ trụ"}, {en: "Ferry", vi: "Phà"}, {en: "Cruise ship", vi: "Tàu du lịch"}, {en: "Yacht", vi: "Du thuyền"},
                    {en: "Ambulance", vi: "Xe cứu thương"}, {en: "Fire truck", vi: "Xe cứu hỏa"}, {en: "Police car", vi: "Xe cảnh sát"}, {en: "Taxi", vi: "Taxi"},
                    {en: "Van", vi: "Xe tải nhỏ"}, {en: "Truck", vi: "Xe tải lớn"}, {en: "Bicycle", vi: "Xe đạp"}, {en: "Hot air balloon", vi: "Kinh khí cầu"}
                ],
                columns: 6,
                basePointsPerMatch: 170,
                efficiencyBonusBase: 780,
                timeLimitMedium: 270
            },
            {
                level: 24,
                pairs: [
                    {en: "Hammer", vi: "Búa"}, {en: "Screwdriver", vi: "Tua vít"}, {en: "Wrench", vi: "Cờ lê"}, {en: "Pliers", vi: "Kìm"},
                    {en: "Saw", vi: "Cưa"}, {en: "Drill", vi: "Máy khoan"}, {en: "Shovel", vi: "Xẻng"}, {en: "Rake", vi: "Cào"},
                    {en: "Ladder", vi: "Thang"}, {en: "Scissors", vi: "Kéo"}, {en: "Tape measure", vi: "Thước dây"}, {en: "Nail", vi: "Đinh"},
                    {en: "Screw", vi: "Ốc vít"}, {en: "Bolt", vi: "Bu lông"}, {en: "Nut", vi: "Đai ốc"}, {en: "Axe", vi: "Rìu"}
                ],
                columns: 6,
                basePointsPerMatch: 175,
                efficiencyBonusBase: 810,
                timeLimitMedium: 280
            },
            {
                level: 25,
                pairs: [
                    {en: "Pen", vi: "Bút mực"}, {en: "Pencil", vi: "Bút chì"}, {en: "Eraser", vi: "Cục tẩy"}, {en: "Ruler", vi: "Thước kẻ"},
                    {en: "Notebook", vi: "Vở"}, {en: "Textbook", vi: "Sách giáo khoa"}, {en: "Backpack", vi: "Ba lô"}, {en: "Desk", vi: "Bàn học"},
                    {en: "Chalkboard", vi: "Bảng đen"}, {en: "Whiteboard", vi: "Bảng trắng"}, {en: "Computer", vi: "Máy vi tính"}, {en: "Calculator", vi: "Máy tính bỏ túi"},
                    {en: "Library", vi: "Thư viện"}, {en: "Classroom", vi: "Lớp học"}, {en: "Homework", vi: "Bài tập về nhà"}, {en: "Exam", vi: "Kỳ thi"},
                    {en: "Degree", vi: "Bằng cấp"}, {en: "Diploma", vi: "Chứng chỉ"}, {en: "University", vi: "Đại học"}, {en: "College", vi: "Cao đẳng"},
                    {en: "Subject", vi: "Môn học"}, {en: "Lesson", vi: "Bài học"}, {en: "Grade", vi: "Điểm số"}, {en: "Scholarship", vi: "Học bổng"}
                ],
                columns: 6,
                basePointsPerMatch: 180,
                efficiencyBonusBase: 850,
                timeLimitMedium: 360
            }
        ];

        const difficultySettings = {
            easy:   { flipTimeout: 1800, scoreMultiplier: 0.8, timeBonusFactor: 0.5, timerMultiplier: 1.5,  name: "Easy" },
            medium: { flipTimeout: 1000, scoreMultiplier: 1.0, timeBonusFactor: 1.0, timerMultiplier: 1.0,  name: "Medium" },
            hard:   { flipTimeout: 600,  scoreMultiplier: 1.5, timeBonusFactor: 1.5, timerMultiplier: 0.75, name: "Hard" }
        };
        let currentDifficulty = 'medium';

        let currentLevelIndex = 0;
        let cardsArray = [];
        let cardDataList = [];

        let flippedCards = [];
        let matchedPairs = 0;
        let flipsThisLevel = 0;
        let lockBoard = false;
        let totalGameScore = 0;
        let topScores = [];

        let timerInterval;
        let timeLeft;
        let currentLevelTimeLimit;
        let timeBonus = 0;
        let gamePaused = false;

        const PENALTY_PER_EXTRA_FLIP = 5;
        const TIME_BONUS_BASE_POINTS = 50;
        const TOP_SCORE_COUNT = 5;
        const LOCAL_STORAGE_TOP_SCORES_KEY = 'ivsMemoryMatchTopScores_v5_multiLang';
        const LOCAL_STORAGE_DIFFICULTY_KEY = 'ivsMemoryMatchDifficulty_v5_multiLang';
        const LOCAL_STORAGE_LANGUAGE_KEY = 'ivsMemoryMatchLanguage_v1';


        languageSwitcherButton.addEventListener('click', () => {
            currentLanguage = currentLanguage === 'en' ? 'vi' : 'en';
            localStorage.setItem(LOCAL_STORAGE_LANGUAGE_KEY, currentLanguage);
            applyTranslations(currentLanguage);
            if (!messageOverlay.classList.contains('hidden')) {
                updateDynamicMessageTranslations();
            }
            if (!nameInputOverlay.classList.contains('hidden')) {
                 updateDynamicMessageTranslations();
            }
            if (!pauseOverlay.classList.contains('hidden')) {
                 updateDynamicMessageTranslations();
            }
             if (scoreboardList.querySelector('li')?.textContent === translations.en.noHighScores || scoreboardList.querySelector('li')?.textContent === translations.vi.noHighScores) {
                renderTopScores();
            }
        });

        function updateDynamicMessageTranslations() {
            const messageTitleKey = messageTitleEl.dataset.translateDynamicKey;
            const messageTextKey = messageTextEl.dataset.translateDynamicKey;
            const nextActionKey = nextActionButton.dataset.translateDynamicKey;

            if (messageTitleKey && translations[currentLanguage][messageTitleKey]) {
                messageTitleEl.innerHTML = translations[currentLanguage][messageTitleKey].replace('{level}', allLevelsData[currentLevelIndex]?.level || 1);
            }
            if (messageTextKey && translations[currentLanguage][messageTextKey]) {
                messageTextEl.textContent = translations[currentLanguage][messageTextKey].replace('{level}', allLevelsData[currentLevelIndex]?.level || 1);
            }
             if (nextActionKey && translations[currentLanguage][nextActionKey]) {
                nextActionButton.textContent = translations[currentLanguage][nextActionKey];
            }
        }


        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            if (gamePaused) return;
            timeLeft = currentLevelTimeLimit;
            timeDisplay.textContent = formatTime(timeLeft);
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (gamePaused) return;
                timeLeft--;
                timeDisplay.textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeUp();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function togglePauseGame() {
            gamePaused = !gamePaused;
            const pauseResumeButtonSpan = pauseResumeButton.querySelector('span');

            if (gamePaused) {
                stopTimer();
                lockBoard = true;
                if(pauseResumeButtonSpan) pauseResumeButtonSpan.textContent = translations[currentLanguage].resume;
                pauseOverlay.classList.remove('hidden');
            } else {
                lockBoard = false;
                startTimer();
                 if(pauseResumeButtonSpan) pauseResumeButtonSpan.textContent = translations[currentLanguage].pause;
                pauseOverlay.classList.add('hidden');
            }
            if (!pauseOverlay.classList.contains('hidden')) {
                document.querySelector('#pause-overlay [data-translate="gamePausedTitle"]').innerHTML = translations[currentLanguage].gamePausedTitle;
                document.querySelector('#pause-overlay [data-translate="gamePausedText"]').textContent = translations[currentLanguage].gamePausedText;
                resumeGameButtonModal.querySelector('span').textContent = translations[currentLanguage].resume;
            }
        }

        pauseResumeButton.addEventListener('click', togglePauseGame);
        resumeGameButtonModal.addEventListener('click', togglePauseGame);


        function handleTimeUp() {
            if (gamePaused) return;
            lockBoard = true;
            messageTitleEl.innerHTML = translations[currentLanguage].messageTitleTimesUp;
            messageTextEl.textContent = translations[currentLanguage].messageTextTimesUpLevel.replace('{level}', allLevelsData[currentLevelIndex].level);
            levelScoreMessageDisplay.textContent = translations[currentLanguage].levelScoreTimeOut;

            messageTitleEl.dataset.translateDynamicKey = 'messageTitleTimesUp';
            messageTextEl.dataset.translateDynamicKey = 'messageTextTimesUpLevel';


            finalFlipsDisplay.textContent = flipsThisLevel;
            timeBonusMessageDisplay.textContent = "0";
            messageOverlay.classList.remove('hidden');

            nextActionButton.textContent = translations[currentLanguage].nextActionRestartLevel;
            nextActionButton.dataset.translateDynamicKey = 'nextActionRestartLevel';
            nextActionButton.onclick = () => {
                if (currentLevelIndex === 0) totalGameScore = 0;
                setupLevel(currentLevelIndex);
            };
        }


        function loadDifficulty() {
            const savedDifficulty = localStorage.getItem(LOCAL_STORAGE_DIFFICULTY_KEY);
            if (savedDifficulty && difficultySettings[savedDifficulty]) {
                currentDifficulty = savedDifficulty;
            }
            updateDifficultyButtonsUI();
        }

        function saveDifficulty() {
            localStorage.setItem(LOCAL_STORAGE_DIFFICULTY_KEY, currentDifficulty);
        }

        function updateDifficultyButtonsUI() {
            difficultyButtons.forEach(button => {
                if (button.dataset.difficulty === currentDifficulty) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentDifficulty = button.dataset.difficulty;
                saveDifficulty();
                updateDifficultyButtonsUI();
                if (currentLevelIndex === 0 && flipsThisLevel === 0) {
                     totalGameScore = 0;
                }
                setupLevel(currentLevelIndex);
            });
        });

        function loadTopScores() {
            const storedScores = localStorage.getItem(LOCAL_STORAGE_TOP_SCORES_KEY);
            if (storedScores) {
                try {
                    topScores = JSON.parse(storedScores);
                } catch (e) {
                    topScores = [];
                }
            } else {
                topScores = [];
            }
            renderTopScores();
        }

        function saveTopScores() {
            try {
                localStorage.setItem(LOCAL_STORAGE_TOP_SCORES_KEY, JSON.stringify(topScores));
            } catch (e) {
            }
        }

        function addScoreToBoard(name, score) {
            topScores.push({ name, score });
            topScores.sort((a, b) => b.score - a.score);
            topScores = topScores.slice(0, TOP_SCORE_COUNT);
            saveTopScores();
            renderTopScores();
        }

        function renderTopScores() {
            scoreboardList.innerHTML = '';
            if (topScores.length === 0) {
                const li = document.createElement('li');
                li.textContent = translations[currentLanguage].noHighScores;
                li.className = 'text-center text-gray-500 py-2';
                scoreboardList.appendChild(li);
                return;
            }
            topScores.forEach((entry, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="rank">${index + 1}.</span>
                    <span class="name">${escapeHtml(entry.name)}</span>
                    <span class="score">${entry.score}</span>
                `;
                scoreboardList.appendChild(li);
            });
        }

        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                 .replace(/&g/, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function setupLevel(levelIndex) {
            currentLevelIndex = levelIndex;
            const levelData = allLevelsData[levelIndex];

            gamePaused = false;
            const pauseResumeButtonSpan = pauseResumeButton.querySelector('span');
            if(pauseResumeButtonSpan) pauseResumeButtonSpan.textContent = translations[currentLanguage].pause;

            pauseOverlay.classList.add('hidden');

            gameBoard.innerHTML = '';
            matchedPairs = 0;
            flipsThisLevel = 0;
            flipsCountDisplay.textContent = flipsThisLevel;
            levelDisplay.textContent = levelData.level;
            lockBoard = false;
            messageOverlay.classList.add('hidden');
            nameInputOverlay.classList.add('hidden');
            timeBonus = 0;

            currentLevelTimeLimit = Math.round(levelData.timeLimitMedium * difficultySettings[currentDifficulty].timerMultiplier);


            cardDataList = [];
            levelData.pairs.forEach(pair => {
                const pairId = `${pair.en}-${pair.vi}`;
                cardDataList.push({ id: pairId, display: pair.en, type: 'en' });
                cardDataList.push({ id: pairId, display: pair.vi, type: 'vi' });
            });

            cardDataList.sort(() => 0.5 - Math.random());

            gameBoard.style.gridTemplateColumns = `repeat(${levelData.columns}, 1fr)`;

            cardsArray = [];
            cardDataList.forEach(cardData => {
                const card = document.createElement('div');
                card.classList.add('game-card');
                card.dataset.id = cardData.id;

                const cardFaceFront = document.createElement('div');
                cardFaceFront.classList.add('card-face', 'card-front');

                const cardFaceBack = document.createElement('div');
                cardFaceBack.classList.add('card-face', 'card-back');
                cardFaceBack.textContent = cardData.display;

                card.appendChild(cardFaceFront);
                card.appendChild(cardFaceBack);

                card.addEventListener('click', handleCardClick);
                gameBoard.appendChild(card);
                cardsArray.push(card);
            });
            totalScoreDisplay.textContent = totalGameScore;
            startTimer();
            applyTranslations(currentLanguage);
        }

        function handleCardClick(event) {
            if (lockBoard || timeLeft <= 0 || gamePaused) return;
            const clickedCard = event.currentTarget;

            if (clickedCard.classList.contains('is-flipped') || clickedCard.classList.contains('is-matched')) {
                return;
            }

            flipCard(clickedCard);
            flippedCards.push(clickedCard);

            if (flippedCards.length === 1 && flipsThisLevel === 0 && currentLevelIndex === 0 && totalGameScore === 0) {
                 totalGameScore = 0;
                 totalScoreDisplay.textContent = totalGameScore;
            }

            if (flippedCards.length === 2) {
                flipsThisLevel++;
                flipsCountDisplay.textContent = flipsThisLevel;
                lockBoard = true;
                checkForMatch();
            }
        }

        function flipCard(card) {
            card.classList.add('is-flipped');
        }

        function unflipCards() {
            setTimeout(() => {
                if (timeLeft > 0 && !gamePaused) {
                    flippedCards.forEach(card => card.classList.remove('is-flipped'));
                }
                flippedCards = [];
                if (!gamePaused) lockBoard = false;
            }, difficultySettings[currentDifficulty].flipTimeout);
        }

        function checkForMatch() {
            const [card1, card2] = flippedCards;

            if (card1.dataset.id === card2.dataset.id) {
                card1.classList.add('is-matched');
                card2.classList.add('is-matched');
                matchedPairs++;

                flippedCards = [];
                if (!gamePaused) lockBoard = false;
                if (matchedPairs === allLevelsData[currentLevelIndex].pairs.length) {
                    stopTimer();
                    setTimeout(() => showLevelCompleteMessage(allLevelsData[currentLevelIndex]), 300);
                }
            } else {
                unflipCards();
            }
        }

        function showLevelCompleteMessage(levelData) {
            if (gamePaused) return;
            let scoreFromMatches = levelData.basePointsPerMatch * levelData.pairs.length;

            const idealFlips = levelData.pairs.length;
            let efficiencyBonus = 0;
            if (flipsThisLevel <= idealFlips) {
                efficiencyBonus = levelData.efficiencyBonusBase;
            } else {
                const extraFlips = flipsThisLevel - idealFlips;
                efficiencyBonus = Math.max(0, levelData.efficiencyBonusBase - (extraFlips * PENALTY_PER_EXTRA_FLIP));
            }

            if (timeLeft > 0) {
                 timeBonus = Math.round((timeLeft / currentLevelTimeLimit) * TIME_BONUS_BASE_POINTS * difficultySettings[currentDifficulty].timeBonusFactor);
            } else {
                timeBonus = 0;
            }

            const calculatedLevelScore = Math.round((scoreFromMatches + efficiencyBonus + timeBonus) * difficultySettings[currentDifficulty].scoreMultiplier);
            totalGameScore += calculatedLevelScore;

            finalFlipsDisplay.textContent = flipsThisLevel;
            levelScoreMessageDisplay.textContent = calculatedLevelScore;
            timeBonusMessageDisplay.textContent = timeBonus;
            totalScoreDisplay.textContent = totalGameScore;
            messageOverlay.classList.remove('hidden');

            if (currentLevelIndex < allLevelsData.length - 1) {
                messageTitleEl.innerHTML = translations[currentLanguage].messageTitleExcellent;
                messageTextEl.textContent = translations[currentLanguage].messageTextNextChallenge.replace('{level}', levelData.level);
                nextActionButton.textContent = translations[currentLanguage].nextActionNextLevel;

                messageTitleEl.dataset.translateDynamicKey = 'messageTitleExcellent';
                messageTextEl.dataset.translateDynamicKey = 'messageTextNextChallenge';
                nextActionButton.dataset.translateDynamicKey = 'nextActionNextLevel';

                nextActionButton.onclick = () => setupLevel(currentLevelIndex + 1);
            } else {
                messageTitleEl.innerHTML = translations[currentLanguage].messageTitleAwesome;
                messageTextEl.textContent = translations[currentLanguage].messageTextAllLevelsComplete;
                nextActionButton.textContent = translations[currentLanguage].nextActionPlayAgain;

                messageTitleEl.dataset.translateDynamicKey = 'messageTitleAwesome';
                messageTextEl.dataset.translateDynamicKey = 'messageTextAllLevelsComplete';
                nextActionButton.dataset.translateDynamicKey = 'nextActionPlayAgain';

                nextActionButton.onclick = () => {
                    checkAndPromptForHighScore();
                };
                checkAndPromptForHighScore();
            }
        }

        function checkAndPromptForHighScore() {
            messageOverlay.classList.add('hidden');
            const lowestTopScore = topScores.length < TOP_SCORE_COUNT ? 0 : topScores[TOP_SCORE_COUNT - 1].score;

            if (totalGameScore > 0 && (topScores.length < TOP_SCORE_COUNT || totalGameScore > lowestTopScore)) {
                nameInputOverlay.classList.remove('hidden');
                playerNameInput.value = '';
                playerNameInput.focus();

                document.querySelector('#name-input-overlay [data-translate="highScoreTitle"]').innerHTML = translations[currentLanguage].highScoreTitle;
                document.querySelector('#name-input-overlay [data-translate="highScorePrompt"]').textContent = translations[currentLanguage].highScorePrompt;
                document.querySelector('#name-input-overlay [data-translate-placeholder="enterNamePlaceholder"]').placeholder = translations[currentLanguage].enterNamePlaceholder;
                document.querySelector('#name-input-overlay [data-translate="saveScore"]').textContent = translations[currentLanguage].saveScore;

            } else {
                totalGameScore = 0;
                setupLevel(0);
            }
        }

        submitNameButton.addEventListener('click', () => {
            const playerName = playerNameInput.value.trim();
            if (playerName.length >= 1 && playerName.length <= 10) {
                addScoreToBoard(playerName, totalGameScore);
                nameInputOverlay.classList.add('hidden');
                totalGameScore = 0;
                setupLevel(0);
            } else {
                const tempMsg = document.createElement('div');
                tempMsg.textContent = translations[currentLanguage].alertNameLength;
                tempMsg.style.position = 'fixed';
                tempMsg.style.bottom = '20px';
                tempMsg.style.left = '50%';
                tempMsg.style.transform = 'translateX(-50%)';
                tempMsg.style.backgroundColor = '#FFD700';
                tempMsg.style.color = '#003366';
                tempMsg.style.padding = '10px 20px';
                tempMsg.style.borderRadius = '8px';
                tempMsg.style.zIndex = '2000';
                document.body.appendChild(tempMsg);
                setTimeout(() => {
                    if (document.body.contains(tempMsg)) {
                         document.body.removeChild(tempMsg);
                    }
                }, 3000);
            }
        });

        resetLevelButton.addEventListener('click', () => {
            stopTimer();
            if(currentLevelIndex === 0) {
                totalGameScore = 0;
            }
            if (gamePaused) {
                togglePauseGame();
            }
            setupLevel(currentLevelIndex);
        });

        window.onload = () => {
            currentLanguage = localStorage.getItem(LOCAL_STORAGE_LANGUAGE_KEY) || 'en';
            applyTranslations(currentLanguage);
            loadDifficulty();
            loadTopScores();
            totalGameScore = 0;
            setupLevel(0);
        };
    </script>
</body>
</html>
