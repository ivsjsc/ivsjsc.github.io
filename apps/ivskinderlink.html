<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IVS KinderLink</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        .login-box h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .school-info-login .school-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .school-info-login .school-details {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 30px;
        }


        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            text-align: left;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        #loginError {
            color: #e74c3c;
            margin-top: 15px;
            font-weight: 600;
            display: none;
        }

        .app-container {
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            color: #2c3e50;
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header-left .school-details-header {
            color: #7f8c8d;
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        .app-name-tag {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-block;
        }


        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(102, 126, 234, 0.1);
            padding: 15px 20px;
            border-radius: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .user-details h3 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .user-role {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .logout-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #ee5a24;
            transform: translateY(-1px);
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: #f0f2f5;
        }
        
        .tab-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-title {
            color: #2c3e50; 
            margin-bottom: 25px; 
            font-size: 2em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
            vertical-align: middle;
        }

        .data-table th {
            background: #f8f9fa;
            color: #343a40;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0, 0.05);
            border-left: 5px solid #667eea;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 1.1em;
            color: #7f8c8d;
        }

        .success-message {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .parent-dashboard {
             background: rgba(255, 255, 255, 0.8);
             padding: 25px;
             border-radius: 15px;
        }

        @media (max-width: 768px) {
            .header, .nav-tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>🌟 Đăng Nhập</h1>
            <div class="school-info-login">
                <p class="school-name">Hệ thống Mầm non IVS</p>
                <p class="school-details">Cơ sở Long Thành | Hotline: 0912.345.678</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">👤 Tên đăng nhập</label>
                    <input type="text" id="username" required placeholder="Tên tài khoản do trường cấp">
                </div>
                <div class="form-group">
                    <label for="password">🔒 Mật khẩu</label>
                    <input type="password" id="password" required placeholder="Mật khẩu">
                </div>
                <button type="submit" class="login-btn">🚀 Đăng Nhập</button>
                <p id="loginError">Tên đăng nhập hoặc mật khẩu không đúng.</p>
            </form>
             <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; font-size: 14px; text-align: left;">
                <strong>Tài khoản Demo:</strong><br>
                <small>
                    • Hiệu trưởng: <b>admin</b> / <b>admin123</b><br>
                    • Giáo viên: <b>comai</b> / <b>123456</b><br>
                    • Phụ huynh: <b>phannhien</b> / <b>123456</b>
                </small>
            </div>
        </div>
    </div>

    <div id="mainApp" class="container app-container">
        <header class="header">
            <div class="header-left">
                <h1>Trường Mầm Non IVS - Cơ sở Long Thành</h1>
                <p class="school-details-header">Địa chỉ: 1104, Tổ 6, Ấp Đất Mới, X. Long Phước, H. Long Thành, Đồng Nai | Hotline: 0912.345.678</p>
                <span class="app-name-tag">IVS KinderLink</span>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <h3 id="currentUserName">Admin</h3>
                    <span class="user-role" id="currentUserRole">Hiệu trưởng</span>
                </div>
                <button class="logout-btn" onclick="logout()">🚪 Đăng xuất</button>
            </div>
        </header>

        <div class="nav-tabs" id="navTabs">
            <button data-tab="dashboard" class="nav-tab active" onclick="showTab('dashboard')">📊 Tổng Quan</button>
            <button data-tab="teachers" class="nav-tab" onclick="showTab('teachers')">👩‍🏫 Quản Lý Giáo Viên</button>
            <button data-tab="children" class="nav-tab" onclick="showTab('children')">👶 Quản Lý Trẻ</button>
            <button data-tab="parents" class="nav-tab" onclick="showTab('parents')">👨‍👩‍👧‍👦 Phụ Huynh</button>
            <button data-tab="users" class="nav-tab" onclick="showTab('users')">👥 Quản Lý User</button>
            <button data-tab="camera" class="nav-tab" onclick="showTab('camera')">📹 Camera</button>
        </div>
        
        <div id="dashboard" class="tab-content active"></div>
        
        <div id="teachers" class="tab-content">
            <h2 class="tab-title">👩‍🏫 Quản Lý Thông Tin Giáo Viên</h2>
            <div class="success-message" id="teacherSuccessMessage"></div>
            <form id="teacherForm">
                <div class="form-grid">
                    <div class="form-group"><label for="teacherName">Họ và tên giáo viên</label><input type="text" id="teacherName" required></div>
                    <div class="form-group"><label for="teacherClass">Lớp phụ trách</label><select id="teacherClass" required><option value="">Chọn lớp</option><option value="Lớp Chồi">Lớp Chồi</option><option value="Lớp Lá">Lớp Lá</option></select></div>
                </div>
                <button type="submit" class="btn btn-primary">💾 Lưu Giáo Viên</button>
            </form>
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>ID</th><th>Họ tên</th><th>Lớp phụ trách</th><th>Thao tác</th></tr></thead>
                    <tbody id="teachersTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="children" class="tab-content">
            <h2 class="tab-title">👶 Quản Lý Thông Tin Trẻ Em</h2>
            <div id="childFormContainer">
                 <form id="childForm">
                    <div class="form-grid">
                        <div class="form-group"><label>Họ và tên trẻ</label><input type="text" id="childName" required></div>
                        <div class="form-group"><label>Ngày sinh</label><input type="date" id="childBirthDate" required></div>
                        <div class="form-group"><label>Giới tính</label><select id="childGender" required><option value="">Chọn</option><option value="Nam">Nam</option><option value="Nữ">Nữ</option></select></div>
                        <div class="form-group"><label>Lớp học</label><select id="childClassChild" required><option value="">Chọn</option><option value="Lớp Chồi">Lớp Chồi</option><option value="Lớp Lá">Lớp Lá</option></select></div>
                        <div class="form-group"><label>Địa chỉ</label><input type="text" id="childAddress" required></div>
                        <div class="form-group"><label>Tình trạng sức khỏe</label><textarea id="childHealth" rows="2"></textarea></div>
                    </div>
                    <button type="submit" class="btn btn-primary">💾 Lưu Thông Tin Trẻ</button>
                </form>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>Họ tên</th><th>Lớp</th><th>Địa chỉ</th><th>Thao tác</th></tr></thead>
                    <tbody id="childrenTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <div id="parents" class="tab-content">
            <h2 class="tab-title">👨‍👩‍👧‍👦 Quản Lý Thông Tin Phụ Huynh</h2>
            <div id="parentFormContainer">
                 <form id="parentForm">
                    <div class="form-grid">
                        <div class="form-group"><label>Họ tên cha</label><input type="text" id="fatherName"></div>
                        <div class="form-group"><label>Họ tên mẹ</label><input type="text" id="motherName"></div>
                        <div class="form-group"><label>SĐT cha</label><input type="tel" id="fatherPhone"></div>
                        <div class="form-group"><label>SĐT mẹ</label><input type="tel" id="motherPhone"></div>
                        <div class="form-group"><label>Email</label><input type="email" id="parentEmail"></div>
                        <div class="form-group"><label>Liên kết với trẻ</label><select id="relatedChild" required><option value="">Chọn trẻ</option></select></div>
                    </div>
                    <button type="submit" class="btn btn-primary">💾 Lưu Thông Tin Phụ Huynh</button>
                </form>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>Họ tên cha/mẹ</th><th>Email</th><th>Trẻ liên quan</th><th>Thao tác</th></tr></thead>
                    <tbody id="parentsTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="users" class="tab-content">
            <h2 class="tab-title">👥 Quản Lý Tài Khoản Đăng Nhập</h2>
            <div class="success-message" id="userSuccessMessage"></div>
            <form id="userForm">
                <div class="form-grid">
                    <div class="form-group"><label>Tên đăng nhập</label><input type="text" id="newUsername" required></div>
                    <div class="form-group"><label>Mật khẩu</label><input type="password" id="newPassword" required></div>
                    <div class="form-group"><label>Vai trò</label><select id="newUserRole" required><option value="">Chọn</option><option value="teacher">Giáo viên</option><option value="parent">Phụ huynh</option></select></div>
                    <div class="form-group" id="linkObjectContainer" style="display:none;"><label id="linkObjectLabel"></label><select id="linkObject" required></select></div>
                </div>
                <button type="submit" class="btn btn-primary">🔑 Tạo Tài Khoản</button>
            </form>
            <div class="table-container">
                <table class="data-table">
                    <thead><tr><th>ID</th><th>Tên đăng nhập</th><th>Vai trò</th><th>Đối tượng liên kết</th><th>Thao tác</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="camera" class="tab-content"></div>

    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const db = {
        users: [
            { id: 1, username: 'admin', password: 'admin123', role: 'principal', name: 'Ban Giám Hiệu', linkedId: null },
            { id: 2, username: 'comai', password: '123456', role: 'teacher', name: 'Cô Mai', linkedId: 401 },
            { id: 3, username: 'phannhien', password: '123456', role: 'parent', name: 'PH bé An Nhiên', linkedId: 101 }
        ],
        teachers: [
            { id: 401, name: 'Cô Mai', assignedClass: 'Lớp Chồi' },
            { id: 402, name: 'Cô Lan', assignedClass: 'Lớp Lá' }
        ],
        children: [
            { id: 101, name: 'Nguyễn An Nhiên', birthDate: '2022-05-20', gender: 'Nữ', class: 'Lớp Chồi', address: '123 Đường ABC, Q1, TPHCM', health: 'Bình thường' },
            { id: 102, name: 'Trần Minh Khang', birthDate: '2022-03-15', gender: 'Nam', class: 'Lớp Chồi', address: '456 Đường XYZ, Q2, TPHCM', health: 'Dị ứng sữa' },
            { id: 103, name: 'Lê Thảo Vy', birthDate: '2021-08-10', gender: 'Nữ', class: 'Lớp Lá', address: '789 Đường KLM, Q3, TPHCM', health: 'Bình thường' }
        ],
        parents: [
            { id: 201, fatherName: 'Nguyễn Văn Khoa', motherName: 'Đặng Thị Bích', fatherPhone: '0901234567', motherPhone: '0908765432', email: 'khoa.nv@email.com', childId: 101 },
            { id: 202, fatherName: 'Trần Văn An', motherName: 'Lý Thị Bình', fatherPhone: '0912345678', motherPhone: '0918765432', email: 'an.tv@email.com', childId: 102 }
        ],
        cameras: [
            { id: 301, name: 'Sân chơi', class: 'Chung', url: 'https://placehold.co/600x400/000000/FFFFFF?text=Sân+Chơi' },
            { id: 302, name: 'Lớp Chồi - Góc học tập', class: 'Lớp Chồi', url: 'https://placehold.co/600x400/000000/FFFFFF?text=Lớp+Chồi' },
            { id: 303, name: 'Lớp Lá - Giờ ăn', class: 'Lớp Lá', url: 'https://placehold.co/600x400/000000/FFFFFF?text=Lớp+Lá' }
        ]
    };

    let currentUser = null;
    const loginScreen = document.getElementById('loginScreen');
    const mainApp = document.getElementById('mainApp');
    
    const handleLogin = (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        const foundUser = db.users.find(user => user.username === username && user.password === password);

        if (foundUser) {
            currentUser = foundUser;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('loginForm').reset();
            initializeApp();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    };

    const initializeApp = () => {
        setupPermissions();
        renderAll();
        showTab('dashboard');
    };
    
    const setupPermissions = () => {
        document.querySelectorAll('.nav-tab').forEach(tab => { tab.style.display = 'flex'; });
        const principalOnly = ['users', 'teachers'];
        const teacherOnly = ['children'];
        const parentOnly = ['camera'];

        if (currentUser.role === 'principal') {
        } else if (currentUser.role === 'teacher') {
            principalOnly.forEach(tab => document.querySelector(`[data-tab="${tab}"]`).style.display = 'none');
            document.querySelector('[data-tab="parents"]').style.display = 'none';
        } else if (currentUser.role === 'parent') {
            [...principalOnly, ...teacherOnly, 'parents'].forEach(tab => document.querySelector(`[data-tab="${tab}"]`).style.display = 'none');
        }
        
        document.getElementById('currentUserName').textContent = currentUser.name;
        document.getElementById('userAvatar').textContent = currentUser.name.charAt(0).toUpperCase();
        const roleNames = { principal: 'Hiệu trưởng', teacher: 'Giáo viên', parent: 'Phụ huynh' };
        document.getElementById('currentUserRole').textContent = roleNames[currentUser.role];
    };

    const renderAll = () => {
        renderDashboard();
        renderTeachersTable();
        renderChildrenTable();
        renderParentsTable();
        renderUsersTable();
        populateRelatedChildDropdown();
    };
    
    const renderDashboard = () => {
        const dashboardContent = document.getElementById('dashboard');
        if (currentUser.role === 'parent') {
            const child = db.children.find(c => c.id === currentUser.linkedId);
            const parentInfo = db.parents.find(p => p.childId === currentUser.linkedId);
            dashboardContent.innerHTML = `<h2 class="tab-title">🌟 Thông tin của bé ${child.name}</h2>
                <div class="parent-dashboard" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div><h3>Thông tin cơ bản</h3><p><strong>Ngày sinh:</strong> ${child.birthDate}</p><p><strong>Lớp:</strong> ${child.class}</p><p><strong>Sức khỏe:</strong> ${child.health}</p></div>
                    <div><h3>Thông tin Phụ huynh</h3><p><strong>Cha:</strong> ${parentInfo.fatherName}</p><p><strong>Mẹ:</strong> ${parentInfo.motherName}</p><p><strong>Email:</strong> ${parentInfo.email}</p></div>
                </div>`;
        } else {
            dashboardContent.innerHTML = `<h2 class="tab-title">📊 Tổng Quan Hoạt Động</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number">${db.teachers.length}</div><div class="stat-label">Giáo viên</div></div>
                    <div class="stat-card"><div class="stat-number">${db.children.length}</div><div class="stat-label">Tổng số trẻ</div></div>
                    <div class="stat-card"><div class="stat-number">${db.users.filter(u=>u.role==='parent').length}</div><div class="stat-label">Tài khoản PH</div></div>
                    <div class="stat-card"><div class="stat-number">${db.cameras.length}</div><div class="stat-label">Camera</div></div>
                </div>`;
        }
    };
    
    const showSuccessMessage = (elementId, message) => {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 3000);
    };

    const renderTeachersTable = () => {
        const tableBody = document.getElementById('teachersTableBody');
        tableBody.innerHTML = '';
        db.teachers.forEach(t => {
            tableBody.innerHTML += `<tr><td>${t.id}</td><td>${t.name}</td><td>${t.assignedClass}</td><td><button class="btn btn-danger" onclick="deleteTeacher(${t.id})">Xóa</button></td></tr>`;
        });
    };
    
    const renderChildrenTable = () => {
        const tableBody = document.getElementById('childrenTableBody');
        tableBody.innerHTML = '';
        let childrenToShow = (currentUser.role === 'teacher') 
            ? db.children.filter(c => c.class === db.teachers.find(t=>t.id===currentUser.linkedId).assignedClass)
            : db.children;

        childrenToShow.forEach(c => {
            tableBody.innerHTML += `<tr><td>${c.name}</td><td>${c.class}</td><td>${c.address}</td><td><button class="btn btn-danger" onclick="deleteChild(${c.id})">Xóa</button></td></tr>`;
        });
    };

    const renderParentsTable = () => {
        const tableBody = document.getElementById('parentsTableBody');
        tableBody.innerHTML = '';
        db.parents.forEach(p => {
            const childName = db.children.find(c => c.id === p.childId)?.name || "N/A";
            tableBody.innerHTML += `<tr><td>${p.fatherName || p.motherName}</td><td>${p.email}</td><td>${childName}</td><td><button class="btn btn-danger" onclick="deleteParent(${p.id})">Xóa</button></td></tr>`;
        });
    };

    const renderUsersTable = () => {
        const tableBody = document.getElementById('usersTableBody');
        tableBody.innerHTML = '';
        db.users.filter(u => u.role !== 'principal').forEach(u => {
            let linkedName = "N/A";
            if (u.role === 'teacher') {
                linkedName = `GV: ${db.teachers.find(t => t.id === u.linkedId)?.name}`;
            } else if (u.role === 'parent') {
                linkedName = `PH bé: ${db.children.find(c => c.id === u.linkedId)?.name}`;
            }
            tableBody.innerHTML += `<tr><td>${u.id}</td><td>${u.username}</td><td>${u.role}</td><td>${linkedName}</td><td><button class="btn btn-danger" onclick="deleteUser(${u.id})">Xóa</button></td></tr>`;
        });
    };
    
    const populateRelatedChildDropdown = () => {
        const select = document.getElementById('relatedChild');
        select.innerHTML = '<option value="">Chọn trẻ</option>';
        db.children.forEach(child => { select.innerHTML += `<option value="${child.id}">${child.name}</option>`; });
    };

    document.getElementById('teacherForm').addEventListener('submit', (e) => {
        e.preventDefault();
        db.teachers.push({ id: Date.now(), name: document.getElementById('teacherName').value, assignedClass: document.getElementById('teacherClass').value });
        renderTeachersTable();
        e.target.reset();
        showSuccessMessage('teacherSuccessMessage', '✅ Thêm giáo viên thành công!');
    });
    
    document.getElementById('childForm').addEventListener('submit', (e) => {
        e.preventDefault();
        db.children.push({ id: Date.now(), name: document.getElementById('childName').value, birthDate: document.getElementById('childBirthDate').value, gender: document.getElementById('childGender').value, class: document.getElementById('childClassChild').value, address: document.getElementById('childAddress').value, health: document.getElementById('childHealth').value });
        renderChildrenTable();
        populateRelatedChildDropdown();
        e.target.reset();
    });

    document.getElementById('parentForm').addEventListener('submit', (e) => {
        e.preventDefault();
        db.parents.push({ id: Date.now(), fatherName: document.getElementById('fatherName').value, motherName: document.getElementById('motherName').value, fatherPhone: document.getElementById('fatherPhone').value, motherPhone: document.getElementById('motherPhone').value, email: document.getElementById('parentEmail').value, childId: parseInt(document.getElementById('relatedChild').value) });
        renderParentsTable();
        e.target.reset();
    });

    document.getElementById('userForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const role = document.getElementById('newUserRole').value;
        const linkedId = parseInt(document.getElementById('linkObject').value);
        let name = "";
        if (role === 'teacher') name = db.teachers.find(t => t.id === linkedId)?.name;
        else if (role === 'parent') name = `PH bé ${db.children.find(c => c.id === linkedId)?.name}`;

        db.users.push({ id: Date.now(), username: document.getElementById('newUsername').value, password: document.getElementById('newPassword').value, role, name, linkedId });
        renderUsersTable();
        e.target.reset();
        document.getElementById('linkObjectContainer').style.display = 'none';
        showSuccessMessage('userSuccessMessage', '✅ Tạo tài khoản thành công!');
    });
    
    document.getElementById('newUserRole').addEventListener('change', (e) => {
        const role = e.target.value;
        const container = document.getElementById('linkObjectContainer');
        const label = document.getElementById('linkObjectLabel');
        const select = document.getElementById('linkObject');
        select.innerHTML = '';
        if (role === 'teacher') {
            label.textContent = "Liên kết với Giáo viên";
            db.teachers.forEach(t => select.innerHTML += `<option value="${t.id}">${t.name}</option>`);
            container.style.display = 'block';
        } else if (role === 'parent') {
            label.textContent = "Liên kết với Trẻ";
            db.children.forEach(c => select.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    });
    
    window.deleteTeacher = (id) => { if(confirm('Xóa giáo viên? Tài khoản liên kết cũng sẽ bị xóa.')) { db.teachers = db.teachers.filter(t=>t.id!==id); db.users = db.users.filter(u=>!(u.role==='teacher' && u.linkedId===id)); renderAll(); }};
    window.deleteChild = (id) => { if(confirm('Xóa trẻ? Toàn bộ thông tin phụ huynh và tài khoản liên kết sẽ bị xóa.')) { db.children = db.children.filter(c=>c.id!==id); db.parents = db.parents.filter(p=>p.childId!==id); db.users = db.users.filter(u=>!(u.role==='parent' && u.linkedId===id)); renderAll(); }};
    window.deleteParent = (id) => { if(confirm('Xóa phụ huynh?')) { db.parents = db.parents.filter(p=>p.id!==id); renderAll(); }};
    window.deleteUser = (id) => { if(confirm('Xóa tài khoản?')) { db.users = db.users.filter(u=>u.id!==id); renderAll(); }};

    window.showTab = (tabName) => {
        if(document.querySelector(`[data-tab="${tabName}"]`).style.display === 'none') return;
        document.querySelectorAll('.tab-content, .nav-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    };

    window.logout = () => {
        currentUser = null;
        mainApp.style.display = 'none';
        loginScreen.style.display = 'flex';
    };

    document.getElementById('loginForm').addEventListener('submit', handleLogin);
});
</script>
</body>
</html>
