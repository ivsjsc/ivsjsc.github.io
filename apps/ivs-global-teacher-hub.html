<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="page_title_teacher_hub">IVS Global Teacher Hub</title>
    <meta name="description" content="Tham gia cộng đồng giáo viên toàn cầu của IVS JSC. Đăng ký ứng tuyển hoặc khám phá mạng lưới giáo viên tài năng." data-lang-key="meta_description_teacher_hub">
    <meta name="keywords" content="IVS JSC, teacher hub, global teachers, apply for teaching, teaching jobs, international education" data-lang-key="meta_keywords_teacher_hub">
    <meta property="og:title" content="IVS Global Teacher Hub - IVS JSC" data-lang-key="og_title_teacher_hub">
    <meta property="og:description" content="Tham gia cộng đồng giáo viên toàn cầu của IVS JSC. Đăng ký ứng tuyển hoặc khám phá mạng lưới giáo viên tài năng." data-lang-key="og_description_teacher_hub">
    <meta property="og:image" content="/images/logo/logo-192.png">
    <meta property="og:url" content="https://ivsacademy.edu.vn/ivs-global-teacher-hub.html">
    <meta property="og:type" content="website">
    <meta name="author" content="IVS JSC">

    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/images/logo/logo-192.png">
    <link rel="manifest" href="/manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"></noscript>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Tailwind CSS CDN - Note: Console warning about using CDN in production is expected for now. -->
    <script src="https://cdn.tailwindcss.com?plugins=typography,forms,aspect-ratio"></script> 
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#004080', 
                        'primary-dark': '#003366',
                        'secondary': '#ffc107', 
                        'secondary-dark': '#e0a800',
                        'header-orange': '#F97316', 
                        'ivs-neutral-800': '#1f2937',
                        'ivs-neutral-700': '#374151',
                        'ivs-neutral-600': '#4B5563',
                        'ivs-neutral-300': '#D1D5DB',
                        'ivs-neutral-200': '#e5e7eb',
                        'ivs-neutral-100': '#f3f4f6',
                        'ivs-neutral-50': '#f9fafb',
                        'purple-accent': '#8b5cf6',
                        'warning': '#f59e0b',
                        'blue-50': '#eff6ff',
                        'blue-200': '#bfdbfe',
                        'blue-500': '#3b82f6',
                        'blue-600': '#2563eb', 
                        'blue-700': '#1d4ed8',
                        'blue-800': '#1e40af',
                        'purple-50': '#faf5ff',
                        'purple-500': '#a855f7',
                        'purple-600': '#9333ea',
                        'purple-700': '#7e2d87',
                        'emerald-50': '#ecfdf5',
                        'emerald-200': '#a7f3d0',
                        'emerald-500': '#10b981',
                        'emerald-600': '#059669',
                        'amber-200': '#fde68a',
                        'amber-500': '#f59e0b',
                        'orange-200': '#fed7aa',
                        'orange-500': '#f97316',
                        'teal-600': '#0d9488',
                        'indigo-600': '#4f46e5',
                        'indigo-700': '#4338ca',
                        'pink-500': '#ec4899'
                    }
                }
            },
            // Fixed: Removed plugins array as they are loaded via CDN URL params and require() is not browser-compatible here.
            plugins: [], 
        }
    </script>

    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <!-- Paths to CSS files are assumed to be correct relative to the server root -->
    <link rel="stylesheet" href="/css/styles.css"> 
    <link rel="stylesheet" href="/dist/output.css"> 
    <style>
        :root {
            --primary-color: #004080;
            --primary-dark-color: #003366;
            --ivs-neutral-800-color: #1f2937;
            --ivs-neutral-700-color: #374151;
            --ivs-neutral-300-color: #D1D5DB;
            --ivs-neutral-200-color: #e5e7eb;
            --ivs-neutral-50-color: #f9fafb;
        }
        .hub-container {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 900px;
            width: 100%;
            text-align: center;
            margin: 2rem auto;
        }
        .button-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            cursor: pointer;
            border: none;
        }
        .button-primary:hover {
            background-color: var(--primary-dark-color);
        }
        .input-field {
            width: 100%;
            padding: 0.85rem;
            margin-bottom: 1rem;
            border: 1px solid var(--ivs-neutral-300-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.07);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 64, 128, 0.2);
            outline: none;
        }
        .textarea-field {
            width: 100%;
            padding: 0.85rem;
            margin-bottom: 1rem;
            border: 1px solid var(--ivs-neutral-300-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            min-height: 120px;
            resize: vertical;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.07);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
         .textarea-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 64, 128, 0.2);
            outline: none;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050; /* Ensure modal is above other content */
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease;
        }
        .modal.show {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        .modal-content button {
            margin-top: 1.5rem;
        }
        .tab-button {
            padding: 0.85rem 1.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            background-color: var(--ivs-neutral-200-color);
            color: var(--ivs-neutral-800-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .tab-button:hover {
            background-color: var(--ivs-neutral-300-color);
            border-color: var(--primary-color);
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-dark-color);
            box-shadow: 0 4px 10px rgba(0, 64, 128, 0.2);
        }
        .teacher-card {
            background-color: var(--ivs-neutral-50-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--ivs-neutral-200-color);
        }
        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }
        .teacher-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 1rem;
            border: 4px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 64, 128, 0.2);
        }
        .dark .hub-container {
            background-color: var(--ivs-neutral-800-color);
        }
        .dark .input-field, .dark .textarea-field {
            background-color: var(--ivs-neutral-700-color);
            border-color: var(--ivs-neutral-600-color);
            color: var(--ivs-neutral-100-color);
        }
        .dark .input-field::placeholder, .dark .textarea-field::placeholder {
            color: var(--ivs-neutral-400-color); /* Adjusted placeholder color for dark mode */
        }
        .dark .input-field:focus, .dark .textarea-field:focus {
            border-color: var(--secondary-color); /* Using secondary for dark mode focus for contrast */
            box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3); /* Secondary color shadow */
        }
        .dark .tab-button {
            background-color: var(--ivs-neutral-700-color);
            color: var(--ivs-neutral-200-color);
        }
         .dark .tab-button:hover {
            background-color: var(--ivs-neutral-600-color);
            border-color: var(--secondary-color);
        }
        .dark .tab-button.active {
            background-color: var(--secondary-color); 
            color: var(--primary-dark-color); /* Dark text on gold for contrast */
            border-color: var(--secondary-dark-color);
        }
        .dark .teacher-card {
            background-color: var(--ivs-neutral-700-color); /* Darker card for dark mode */
            border-color: var(--ivs-neutral-600-color);
        }
        .dark .teacher-card img {
            border-color: var(--secondary-color);
        }
        .dark .modal-content {
            background-color: var(--ivs-neutral-800-color); /* Dark modal */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-300 antialiased font-inter" id="page-teacher-hub">
    
    <div id="header-placeholder" data-loading-text="Đang tải menu..."></div>

    <div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-gray-200/75 dark:bg-gray-900/75 z-[1100] hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary dark:border-secondary"></div>
    </div>

    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="text-lg font-medium text-gray-800 dark:text-gray-100"></p>
            <button id="modal-close-button" class="button-primary dark:bg-secondary dark:text-primary-dark dark:hover:bg-secondary-dark">Đóng</button>
        </div>
    </div>

    <main class="hub-container dark:text-gray-200 px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl md:text-4xl font-bold text-primary dark:text-secondary mb-4" data-lang-key="hub_main_title">IVS Global Teacher Hub</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-3" data-lang-key="hub_subtitle">Tham gia cộng đồng giáo viên quốc tế của IVS JSC. Chúng tôi kết nối tài năng sư phạm với các cơ hội giảng dạy chất lượng cao tại Việt Nam và trên toàn cầu.</p>
        <p id="user-id-display" class="text-sm text-gray-500 dark:text-gray-500 mb-8">User ID: Đang tải...</p>

        <div class="flex justify-center space-x-3 sm:space-x-4 mb-10">
            <button id="apply-tab-button" class="tab-button active" data-lang-key="hub_tab_apply">Ứng tuyển ngay</button>
            <button id="view-teachers-tab-button" class="tab-button" data-lang-key="hub_tab_view_teachers">Xem danh sách giáo viên</button>
        </div>

        <div id="teacher-application-section" class="text-left">
            <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4" data-lang-key="hub_apply_form_title">Biểu mẫu Ứng tuyển Giáo viên</h2>
            <p class="text-gray-700 dark:text-gray-300 mb-6" data-lang-key="hub_apply_form_desc">Vui lòng điền đầy đủ thông tin dưới đây để gia nhập đội ngũ giáo viên quốc tế của IVS. Các thông tin này sẽ được sử dụng để đánh giá và kết nối bạn với các cơ hội phù hợp.</p>

            <form id="teacher-application-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <div>
                        <label for="fullName" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-lang-key="form_fullName">Họ và Tên:</label>
                        <input type="text" id="fullName" name="fullName" class="input-field" placeholder="Nguyễn Văn A" required>
                    </div>
                    <div>
                        <label for="email" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-lang-key="form_email">Địa chỉ Email:</label>
                        <input type="email" id="email" name="email" class="input-field" placeholder="your.email@example.com" required>
                    </div>
                    <div>
                        <label for="phoneNumber" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-lang-key="form_phoneNumber">Số điện thoại:</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="input-field" placeholder="+84 123 456 789" required>
                    </div>
                    <div>
                        <label for="nationality" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-lang-key="form_nationality">Quốc tịch:</label>
                        <input type="text" id="nationality" name="nationality" class="input-field" placeholder="Ví dụ: Việt Nam, American" required>
                    </div>
                    <div>
                        <label for="qualification" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-lang-key="form_qualification">Bằng cấp cao nhất:</label>
                        <input type="text" id="qualification" name="qualification" class="input-field" placeholder="Ví dụ: Thạc sĩ Giáo dục, Cử nhân Ngôn ngữ Anh, TESOL" required>
                    </div>
                    <div>
                        <label for="experience" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-lang-key="form_experience">Số năm kinh nghiệm giảng dạy:</label>
                        <input type="number" id="experience" name="experience" class="input-field" placeholder="Ví dụ: 5" min="0" required>
                    </div>
                </div>

                <label for="subjects" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2 mt-4" data-lang-key="form_subjects">Các môn có thể giảng dạy (cách nhau bằng dấu phẩy):</label>
                <input type="text" id="subjects" name="subjects" class="input-field" placeholder="Ví dụ: Tiếng Anh giao tiếp, IELTS, Toán, Khoa học" required>

                <label for="bio" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2 mt-4" data-lang-key="form_bio">Giới thiệu ngắn về bản thân (tối đa 300 từ):</label>
                <textarea id="bio" name="bio" class="textarea-field" placeholder="Nêu bật kinh nghiệm giảng dạy, phong cách và chứng chỉ liên quan..." maxlength="300" required></textarea>

                <p class="text-gray-600 dark:text-gray-400 text-sm mt-4 mb-2" data-lang-key="form_upload_notice">Để nộp CV, ảnh hồ sơ, hoặc các tài liệu khác (video, PDF), vui lòng chuẩn bị các tệp này trên một dịch vụ lưu trữ đám mây (ví dụ: Google Drive, Dropbox) và cung cấp liên kết công khai hoặc có quyền truy cập phù hợp vào các ô dưới đây.</p>

                <label for="resumeUrl" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2 mt-4" data-lang-key="form_resumeUrl">Liên kết CV/Hồ sơ năng lực trực tuyến (tùy chọn):</label>
                <input type="url" id="resumeUrl" name="resumeUrl" class="input-field" placeholder="https://your-cv-link.com">

                <label for="photoUrl" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2 mt-4" data-lang-key="form_photoUrl">Liên kết ảnh hồ sơ (tùy chọn):</label>
                <input type="url" id="photoUrl" name="photoUrl" class="input-field" placeholder="https://your-photo-link.com">

                <button type="submit" class="button-primary w-full mt-6 py-3 text-base dark:bg-secondary dark:text-primary-dark dark:hover:bg-secondary-dark" data-lang-key="form_submit_button">Gửi Hồ sơ Ứng tuyển</button>
            </form>
        </div>

        <div id="teacher-overview-section" class="hidden text-left">
            <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4" data-lang-key="hub_teacher_list_title">Danh sách Giáo viên Hợp tác</h2>
            <p class="text-gray-700 dark:text-gray-300 mb-6" data-lang-key="hub_teacher_list_desc">Đây là danh sách các giáo viên nước ngoài đang hợp tác cùng IVS, đã được tuyển chọn kỹ lưỡng để đáp ứng nhu cầu của các đối tác.</p>
            <div id="teachers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <p id="no-teachers-message" class="text-gray-500 dark:text-gray-400 text-center col-span-full hidden" data-lang-key="hub_no_teachers">Hiện chưa có giáo viên nào được hiển thị.</p>
            </div>
        </div>
    </main>

    <div id="fab-container-placeholder"></div>
    <div id="footer-placeholder" data-loading-text="Đang tải chân trang..."></div>
    
    <button id="scrollToTopBtn" class="hidden fixed bottom-5 right-5 z-[1040] items-center justify-center w-10 h-10 md:w-12 md:h-12 rounded-full bg-primary text-white shadow-lg hover:bg-primary-dark transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 dark:bg-secondary dark:hover:bg-secondary-dark dark:focus:ring-secondary" aria-label="Scroll to top">
        <i class="fas fa-arrow-up text-lg md:text-xl" aria-hidden="true"></i>
    </button>
    
    <!-- Dummy applyLanguage to prevent error if language.js loads late -->
    <script>
      // This dummy function acts as a fallback if language.js hasn't loaded yet
      // or if loadComponents.js tries to call it prematurely.
      if (typeof window.applyLanguage === 'undefined') {
        window.applyLanguage = function(lang) {
          console.log('Dummy applyLanguage (Teacher Hub) called for:', lang || 'default');
          // You could add minimal fallback behavior here if needed, e.g., setting document lang
          // document.documentElement.lang = lang || 'vi';
        };
      }
    </script>
    <!-- Actual scripts should be loaded relative to the HTML file's location or from root if paths start with / -->
    <script src="/js/language.js"></script>
    <script src="/js/loadComponents.js"></script>
    <script src="/js/script.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, serverTimestamp, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // __app_id and __firebase_config are expected to be injected by the environment (e.g., Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-teacher-hub';
        
        let app;
        let db;
        let auth;
        let userId = 'Đang tải...';
        let isAuthReady = false;

        const applyTabButton = document.getElementById('apply-tab-button');
        const viewTeachersTabButton = document.getElementById('view-teachers-tab-button');
        const teacherApplicationSection = document.getElementById('teacher-application-section');
        const teacherOverviewSection = document.getElementById('teacher-overview-section');
        const teacherApplicationForm = document.getElementById('teacher-application-form');
        const teachersList = document.getElementById('teachers-list');
        const noTeachersMessage = document.getElementById('no-teachers-message');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingSpinner = document.getElementById('loading-spinner');

        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseButton = document.getElementById('modal-close-button');

        function showModal(message) {
            if (modalMessage) modalMessage.innerHTML = message; // Allow HTML in messages
            if (customModal) customModal.classList.add('show');
        }

        function hideModal() {
            if (customModal) customModal.classList.remove('show');
        }

        if (modalCloseButton) modalCloseButton.addEventListener('click', hideModal);
        
        function showLoadingSpinner() {
            if(loadingSpinner) loadingSpinner.classList.remove('hidden');
        }

        function hideLoadingSpinner() {
            if(loadingSpinner) loadingSpinner.classList.add('hidden');
        }

        window.onload = async function() {
            showLoadingSpinner();
            let firebaseConfigObject = {};
            let parsedSuccessfully = false;

            // Attempt to parse __firebase_config
            if (typeof __firebase_config !== 'undefined' && __firebase_config !== null && String(__firebase_config).trim() !== '') {
                try {
                    firebaseConfigObject = JSON.parse(__firebase_config);
                    parsedSuccessfully = true;
                } catch (e) {
                    console.error("Lỗi phân tích cấu hình Firebase (dự kiến từ __firebase_config):", e);
                    // Error will be handled in the next check
                }
            } else {
                 console.warn("Biến __firebase_config không được cung cấp hoặc trống. Các tính năng Firebase sẽ không hoạt động.");
            }
            
            // Check for critical Firebase config fields OR if parsing failed
            if (!parsedSuccessfully || !firebaseConfigObject.apiKey || !firebaseConfigObject.authDomain || !firebaseConfigObject.projectId) {
                console.error("Cấu hình Firebase không hợp lệ, thiếu trường quan trọng, hoặc không được cung cấp.");
                if (typeof __firebase_config !== 'undefined' && __firebase_config !== null) { // Only show modal if config was expected
                     showModal("Lỗi cấu hình hệ thống Firebase. Không thể khởi tạo dịch vụ. (Mã lỗi: CFG_ERR)");
                } else {
                    // If __firebase_config was truly undefined (not just empty or bad JSON), this is a dev environment state.
                    // UI should reflect that Firebase features are unavailable.
                    if(userIdDisplay) userIdDisplay.textContent = 'User ID: Lỗi CFG';
                }
                
                hideLoadingSpinner();
                AOS.init({ duration: 800, once: true, offset: 50 }); 
                initializeScrollToTop(); 
                return; 
            }

            // Proceed with Firebase initialization
            try {
                app = initializeApp(firebaseConfigObject);
                db = getFirestore(app);
                auth = getAuth(app);

                const currentInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (currentInitialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, currentInitialAuthToken);
                    } catch (error) {
                        console.warn("Đăng nhập bằng custom token thất bại, thử đăng nhập ẩn danh:", error.message);
                        try {
                            await signInAnonymously(auth);
                        } catch (anonError) {
                            console.error("Lỗi đăng nhập ẩn danh sau khi custom token thất bại:", anonError.message);
                            showModal("Lỗi xác thực người dùng nghiêm trọng. (Mã lỗi: AUTH_CRITICAL)");
                            hideLoadingSpinner();
                            return;
                        }
                    }
                } else {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Lỗi đăng nhập ẩn danh:", error.message);
                        showModal("Lỗi đăng nhập ẩn danh. (Mã lỗi: AUTH_ANON_GENERAL)");
                        hideLoadingSpinner();
                        return;
                    }
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        if(userIdDisplay) userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        if (teacherOverviewSection && viewTeachersTabButton && viewTeachersTabButton.classList.contains('active')) { // Check if tab is active
                            loadApprovedTeachers();
                        }
                    } else {
                        userId = 'N/A (chưa đăng nhập)';
                         if(userIdDisplay) userIdDisplay.textContent = `User ID: ${userId}`;
                        isAuthReady = false;
                         showModal("Người dùng chưa được xác thực. (Mã lỗi: AUTH_NO_USER)");
                    }
                    hideLoadingSpinner();
                });

            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error.message);
                showModal("Không thể khởi tạo ứng dụng Firebase. (Mã lỗi: FB_INIT_CRITICAL)");
                 if(userIdDisplay) userIdDisplay.textContent = 'User ID: Lỗi Init Firebase';
                hideLoadingSpinner();
            }

            AOS.init({
                duration: 800,
                once: true,
                offset: 50,
            });
            initializeScrollToTop();
        };

        function initializeScrollToTop(){
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');
            if (scrollToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 200) {
                        scrollToTopBtn.classList.remove('hidden');
                        scrollToTopBtn.classList.add('flex');
                    } else {
                        scrollToTopBtn.classList.remove('flex');
                        scrollToTopBtn.classList.add('hidden');
                    }
                }, { passive: true });

                scrollToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                if (window.pageYOffset <= 200) { 
                    scrollToTopBtn.classList.add('hidden');
                } else {
                    scrollToTopBtn.classList.remove('hidden');
                    scrollToTopBtn.classList.add('flex');
                }
            }
        }

        if(applyTabButton && viewTeachersTabButton && teacherApplicationSection && teacherOverviewSection){
            applyTabButton.addEventListener('click', () => {
                applyTabButton.classList.add('active');
                viewTeachersTabButton.classList.remove('active');
                teacherApplicationSection.classList.remove('hidden');
                teacherOverviewSection.classList.add('hidden');
            });

            viewTeachersTabButton.addEventListener('click', () => {
                viewTeachersTabButton.classList.add('active');
                applyTabButton.classList.remove('active');
                teacherApplicationSection.classList.add('hidden');
                teacherOverviewSection.classList.remove('hidden');
                if (isAuthReady && db) { 
                    loadApprovedTeachers();
                } else if (!db) {
                     showModal("Kết nối cơ sở dữ liệu thất bại. (Mã lỗi: DB_VIEW_UNAVAILABLE)");
                } else {
                    showModal("Đang xác thực người dùng, vui lòng đợi. (Mã lỗi: AUTH_VIEW_PENDING)");
                }
            });
        }


        if(teacherApplicationForm){
            teacherApplicationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoadingSpinner();

                if (!db || !auth.currentUser || !isAuthReady || userId === 'Đang tải...' || userId.startsWith('N/A')) {
                    showModal("Hệ thống chưa sẵn sàng hoặc người dùng chưa được xác thực. Vui lòng thử lại. (Mã lỗi: SYS_APPLY_NOT_READY)");
                    hideLoadingSpinner();
                    return;
                }
                 const currentUserID = auth.currentUser.uid;


                const fullName = document.getElementById('fullName').value;
                const email = document.getElementById('email').value;
                const phoneNumber = document.getElementById('phoneNumber').value;
                const nationality = document.getElementById('nationality').value;
                const qualification = document.getElementById('qualification').value;
                const experience = parseInt(document.getElementById('experience').value);
                const subjects = document.getElementById('subjects').value.split(',').map(s => s.trim()).filter(s => s);
                const bio = document.getElementById('bio').value;
                const resumeUrl = document.getElementById('resumeUrl').value;
                const photoUrl = document.getElementById('photoUrl').value;

                const newAppRef = doc(collection(db, `artifacts/${appId}/users/${currentUserID}/teacher_applications`));
                const applicationId = newAppRef.id;
                
                const teacherData = {
                    fullName, email, phoneNumber, nationality, qualification, experience, subjects, bio,
                    resumeUrl: resumeUrl || null,
                    photoUrl: photoUrl || `https://placehold.co/100x100/004080/FFFFFF?text=${encodeURIComponent(fullName.charAt(0) || 'GV')}`,
                    submissionTimestamp: serverTimestamp(),
                    userId: currentUserID, 
                    applicationId: applicationId
                };

                const publicTeacherData = {
                    fullName, nationality, qualification, experience, subjects, bio,
                    photoUrl: photoUrl || `https://placehold.co/100x100/004080/FFFFFF?text=${encodeURIComponent(fullName.charAt(0) || 'GV')}`,
                    isApprovedForPublicDisplay: false,
                    applicationId: applicationId,
                    userId: currentUserID 
                };

                try {
                    await setDoc(newAppRef, teacherData);
                    await setDoc(doc(db, `artifacts/${appId}/public/data/teacher_applications`, applicationId), publicTeacherData);
                    showModal("Hồ sơ ứng tuyển của bạn đã được gửi thành công! Vui lòng truy cập <a href='https://docs.google.com/forms/d/e/1FAIpQLSd_TJ-EstYhFVSEAHGzqG-36dsbkdxvYRuGHiCi5PvgUICjnA/viewform?usp=sharing&ouid=109196735657445874239' target='_blank' class='text-blue-600 hover:text-blue-800 underline font-semibold'>liên kết này</a> để tải lên CV, ảnh chân dung và các tài liệu cần thiết khác. (Mã hồ sơ: "+applicationId.substring(0,6)+")");
                    teacherApplicationForm.reset();
                } catch (error) {
                    console.error("Lỗi khi gửi hồ sơ ứng tuyển: ", error.message);
                    showModal("Đã xảy ra lỗi trong quá trình gửi hồ sơ. Vui lòng thử lại sau. (Mã lỗi: SUBMIT_APP_FAIL)");
                } finally {
                    hideLoadingSpinner();
                }
            });
        }

        function loadApprovedTeachers() {
            if (!db || !isAuthReady) {
                console.warn("Firestore hoặc Auth chưa sẵn sàng để tải danh sách giáo viên.");
                 if(teachersList) teachersList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400" data-lang-key="hub_loading_teachers_error">Chưa thể tải danh sách giáo viên. Vui lòng đợi...</p>';
                return;
            }
            if (!teachersList || !noTeachersMessage) {
                 console.warn("Một số thành phần DOM cho danh sách giáo viên không tồn tại.");
                 return;
            }

            showLoadingSpinner();
            const q = query(collection(db, `artifacts/${appId}/public/data/teacher_applications`), where("isApprovedForPublicDisplay", "==", true));
            
            const unsubscribe = onSnapshot(q, (snapshot) => { 
                if (!teachersList) return; 
                teachersList.innerHTML = ''; 
                if (snapshot.empty) {
                    if(noTeachersMessage) noTeachersMessage.classList.remove('hidden');
                } else {
                    if(noTeachersMessage) noTeachersMessage.classList.add('hidden');
                    snapshot.forEach((docSnap) => {
                        const teacher = docSnap.data();
                        const placeholderInitial = encodeURIComponent((teacher.fullName || 'GV').charAt(0).toUpperCase());
                        const teacherCard = `
                            <div class="teacher-card dark:bg-slate-700">
                                <img src="${teacher.photoUrl || `https://placehold.co/100x100/004080/FFFFFF?text=${placeholderInitial}`}" alt="Ảnh của ${teacher.fullName || 'Giáo viên'}" class="mx-auto mb-4" onerror="this.onerror=null; this.src='https://placehold.co/100x100/004080/FFFFFF?text=${placeholderInitial}'; this.alt='Ảnh lỗi';">
                                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-2 text-center">${teacher.fullName || 'Chưa có tên'}</h3>
                                <p class="text-gray-600 dark:text-gray-300 mb-1 text-sm"><strong>Quốc tịch:</strong> ${teacher.nationality || 'Chưa cung cấp'}</p>
                                <p class="text-gray-600 dark:text-gray-300 mb-1 text-sm"><strong>Bằng cấp:</strong> ${teacher.qualification || 'Chưa cung cấp'}</p>
                                <p class="text-gray-600 dark:text-gray-300 mb-1 text-sm"><strong>Kinh nghiệm:</strong> ${teacher.experience !== undefined ? teacher.experience + ' năm' : 'Chưa cung cấp'}</p>
                                <p class="text-gray-600 dark:text-gray-300 mb-1 text-sm"><strong>Môn dạy:</strong> ${(teacher.subjects && Array.isArray(teacher.subjects) && teacher.subjects.length > 0 && teacher.subjects.join(', ')) || 'Chưa cung cấp'}</p>
                                <p class="text-gray-700 dark:text-gray-400 mt-3 text-sm italic text-center">"${teacher.bio || 'Chưa có giới thiệu.'}"</p>
                            </div>
                        `;
                        teachersList.insertAdjacentHTML('beforeend', teacherCard);
                    });
                }
                hideLoadingSpinner();
            }, (error) => {
                console.error("Lỗi tải danh sách giáo viên: ", error.message);
                showModal("Không thể tải danh sách giáo viên. Vui lòng thử lại sau. (Mã lỗi: LOAD_TEACHERS_FAIL)");
                if(teachersList) teachersList.innerHTML = '<p class="text-center text-red-500 dark:text-red-400" data-lang-key="hub_load_teachers_fail_msg">Đã xảy ra lỗi khi tải danh sách giáo viên.</p>';
                hideLoadingSpinner();
            });
            // Consider returning unsubscribe if needed elsewhere for cleanup e.g. on page unload.
        }
    </script>
</body>
</html>

